<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>House Availability – Heat Map</title>
    <style>
      :root {
        color-scheme: light dark;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      }
      body {
        margin: 0;
        padding: 2rem 1rem 4rem;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        background: radial-gradient(circle at top, rgba(26, 115, 232, 0.12), transparent 60%);
      }
      main {
        width: min(920px, 100%);
        display: grid;
        gap: 1.5rem;
      }
      header {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        justify-content: space-between;
        align-items: baseline;
      }
      .hint {
        margin: 0.35rem 0 0;
        font-size: 0.85rem;
        color: rgba(15, 23, 42, 0.65);
      }
      #last-updated {
        font-size: 0.9rem;
        color: rgba(0, 0, 0, 0.68);
      }
      #heat-grid {
        display: grid;
        grid-template-columns: minmax(120px, 0.9fr) repeat(7, minmax(88px, 1fr));
        gap: 8px;
        align-items: stretch;
      }
      .week-container {
        display: contents;
      }
      @media (max-width: 768px) {
        body {
          padding: 1rem 0 2rem;
        }
        main {
          width: 100%;
          padding: 0;
        }
        header {
          padding: 0 1rem;
        }
        #legend {
          padding: 0 1rem;
        }
        #heat-grid {
          display: block;
          overflow-x: auto;
          scroll-snap-type: x mandatory;
          -webkit-overflow-scrolling: touch;
          scrollbar-width: none;
        }
        #heat-grid::-webkit-scrollbar {
          display: none;
        }
        .week-container {
          display: inline-grid;
          grid-template-columns: repeat(7, 1fr);
          gap: 6px;
          width: 100vw;
          padding: 0 1rem;
          box-sizing: border-box;
          scroll-snap-align: start;
        }
        .week-label {
          display: none;
        }
        .weekday.heading {
          font-size: 0.65rem;
          padding-bottom: 4px;
        }
      }
      .week-label {
        font-size: 0.95rem;
        font-weight: 600;
        align-self: center;
        padding-right: 8px;
        color: rgba(15, 23, 42, 0.75);
      }
      .week-label.heading {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: rgba(15, 23, 42, 0.6);
      }
      .weekday {
        text-align: center;
        font-size: 0.8rem;
        font-weight: 600;
        color: rgba(15, 23, 42, 0.72);
      }
      .weekday.heading {
        font-size: 0.7rem;
        letter-spacing: 0.1em;
        color: rgba(15, 23, 42, 0.55);
      }
      .cell {
        aspect-ratio: 1 / 1;
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: #e2e8f0;
        color: #0f172a;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.04);
      }
      .cell:hover {
        transform: translateY(-2px);
        box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.1), 0 8px 18px rgba(15, 23, 42, 0.12);
      }
      .cell.weekend {
        opacity: 0.92;
      }
      .cell.today {
        box-shadow: inset 0 0 0 2px #f97316, 0 6px 14px rgba(249, 115, 22, 0.25);
      }
      .cell.peak:not(.today) {
        box-shadow: inset 0 0 0 2px rgba(59, 130, 246, 0.35);
      }
      .cell.empty {
        background: transparent;
        box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.35);
        opacity: 0.4;
      }
      .count {
        font-size: 1.6rem;
        font-weight: 600;
      }
      .date {
        font-size: 0.78rem;
        opacity: 0.76;
      }
      #legend {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        font-size: 0.85rem;
        color: rgba(15, 23, 42, 0.7);
        align-items: center;
      }
      .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .swatch {
        width: 28px;
        height: 12px;
        border-radius: 999px;
        display: inline-block;
        border: 1px solid rgba(15, 23, 42, 0.08);
      }
    </style>
  </head>
  <body>
    <main>
      <header>
        <div>
          <h1>Evening Heat Map</h1>
          <p id="timezone"></p>
          <p class="hint">Counts how many housemates are free between 18:00 and 22:00.</p>
        </div>
        <div id="last-updated">Loading…</div>
      </header>
      <section id="heat-grid"></section>
      <section id="legend"></section>
    </main>
    <script>
      const palette = [
        "#F1F5F9",
        "#D9E8FB",
        "#BED7F6",
        "#94BFF0",
        "#6DA5E8",
        "#4B89D9",
        "#306CC6",
        "#1B4DA0"
      ];
      const weekdayNames = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];

      const heatGrid = document.getElementById("heat-grid");
      const tzEl = document.getElementById("timezone");
      const lastUpdatedEl = document.getElementById("last-updated");
      const legend = document.getElementById("legend");

      function formatDate(dateStr) {
        const date = new Date(`${dateStr}T00:00:00Z`);
        return date.toLocaleDateString(undefined, {
          month: "short",
          day: "numeric"
        });
      }

      function formatWeekLabel(dateStr) {
        const date = new Date(`${dateStr}T00:00:00Z`);
        return date.toLocaleDateString(undefined, {
          month: "short",
          day: "numeric"
        });
      }

      function formatRelative(datetime, timezone) {
        if (!datetime) return "Not yet synced";
        const date = new Date(datetime);
        const formatted = new Intl.DateTimeFormat(undefined, {
          dateStyle: "medium",
          timeStyle: "short",
          timeZone: timezone
        }).format(date);
        return `Last updated ${formatted}`;
      }

      function getTodayIso(timezone) {
        return new Intl.DateTimeFormat("en-CA", { timeZone: timezone }).format(new Date());
      }

      function buildWeeks(days) {
        const weeks = [];
        let currentWeek = new Array(7).fill(null);

        days.forEach((day) => {
          const dateObj = new Date(`${day.date}T00:00:00Z`);
          const weekday = (dateObj.getUTCDay() + 6) % 7; // Monday-first

          if (currentWeek[weekday]) {
            weeks.push(currentWeek);
            currentWeek = new Array(7).fill(null);
          }

          currentWeek[weekday] = day;

          if (weekday === 6) {
            weeks.push(currentWeek);
            currentWeek = new Array(7).fill(null);
          }
        });

        if (currentWeek.some(Boolean)) {
          weeks.push(currentWeek);
        }

        return weeks;
      }

      function buildLegend(maxCount, scaleMax) {
        legend.innerHTML = "";
        const frag = document.createDocumentFragment();
        const capped = scaleMax || 0;

        for (let i = 0; i <= capped; i += 1) {
          const colorIdx = capped === 0 ? 0 : Math.round((i / capped) * (palette.length - 1));
          const span = document.createElement("span");
          span.className = "legend-item";
          span.innerHTML = `<span class="swatch" style="background:${palette[colorIdx]}"></span>${i} free`;
          frag.appendChild(span);
        }

        legend.appendChild(frag);
      }

      function renderHeatMap(data) {
        const timezone = data.timezone || "Europe/London";
        tzEl.textContent = `Timezone: ${timezone}`;
        lastUpdatedEl.textContent = formatRelative(data.lastUpdatedIso, timezone);

        const weeks = buildWeeks(data.days);
        const todayIso = getTodayIso(timezone);
        const maxFree = data.days.reduce((acc, day) => Math.max(acc, day.freeCount), 0);
        const scaleMax = Math.max(maxFree, palette.length - 1);

        heatGrid.innerHTML = "";
        const frag = document.createDocumentFragment();

        const spacer = document.createElement("div");
        spacer.className = "week-label heading";
        frag.appendChild(spacer);

        weekdayNames.forEach((name) => {
          const head = document.createElement("div");
          head.className = "weekday heading";
          head.textContent = name;
          frag.appendChild(head);
        });

        weeks.forEach((week) => {
          const firstDay = week.find(Boolean);
          const label = document.createElement("div");
          label.className = "week-label";
          label.textContent = firstDay ? `Week of ${formatWeekLabel(firstDay.date)}` : "";
          frag.appendChild(label);

          const weekContainer = document.createElement("div");
          weekContainer.className = "week-container";

          week.forEach((day, idx) => {
            const cell = document.createElement("div");
            cell.className = "cell";

            if (!day) {
              cell.classList.add("empty");
              weekContainer.appendChild(cell);
              return;
            }

            const colorIndex = scaleMax === 0 ? 0 : Math.round((day.freeCount / scaleMax) * (palette.length - 1));
            cell.style.background = palette[Math.min(colorIndex, palette.length - 1)];

            if (idx >= 5) cell.classList.add("weekend");
            if (day.date === todayIso) cell.classList.add("today");
            if (day.freeCount === maxFree && maxFree > 0) cell.classList.add("peak");

            const count = document.createElement("div");
            count.className = "count";
            count.textContent = day.freeCount.toString();

            const dateLabel = document.createElement("div");
            dateLabel.className = "date";
            dateLabel.textContent = formatDate(day.date);

            cell.append(count, dateLabel);
            weekContainer.appendChild(cell);
          });

          frag.appendChild(weekContainer);
        });

        heatGrid.appendChild(frag);
        buildLegend(maxFree, scaleMax);
      }

      async function loadAvailability() {
        const workerOrigin = (function () {
          const { protocol, hostname, port } = window.location;
          if (port === "8788") return `${protocol}//${hostname}:8787`;
          return "https://house-availability.simonwisdom.workers.dev";
        })();

        try {
          const response = await fetch(`${workerOrigin}/api/availability`, {
            credentials: "include"
          });
          if (!response.ok) throw new Error("Request failed");
          const data = await response.json();
          renderHeatMap(data);
        } catch (error) {
          lastUpdatedEl.textContent = "Unable to load availability.";
          console.error(error);
        }
      }

      loadAvailability();
    </script>
  </body>
</html>
