<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>House Availability ‚Äì Heat Map</title>
    <style>
      :root {
        color-scheme: light dark;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      }
      body {
        margin: 0;
        padding: 0.75rem 1rem 4rem;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        background: radial-gradient(circle at top, rgba(26, 115, 232, 0.12), transparent 60%);
      }
      main {
        width: min(920px, 100%);
        display: grid;
        gap: 0.75rem;
      }
      header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
        font-size: 0.9rem;
      }
      header h1 {
        margin: 0;
        font-size: 1.15rem;
        font-weight: 500;
      }
      .account-indicator {
        position: fixed;
        top: 1rem;
        right: 1rem;
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(0, 0, 0, 0.1);
        padding: 0.5rem 0.75rem;
        border-radius: 8px;
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #047857;
      }
      .account-indicator a {
        color: #0f172a;
        text-decoration: none;
        margin-left: 0.25rem;
      }
      #last-updated {
        color: rgba(0, 0, 0, 0.68);
      }
      #heat-grid {
        display: grid;
        grid-template-columns: minmax(120px, 0.9fr) repeat(7, minmax(88px, 1fr));
        gap: 8px;
        align-items: stretch;
      }
      .week-label {
        font-size: 0.95rem;
        font-weight: 600;
        align-self: center;
        padding-right: 8px;
        color: rgba(15, 23, 42, 0.75);
      }
      .week-label.heading {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: rgba(15, 23, 42, 0.6);
      }
      .weekday {
        text-align: center;
        font-size: 0.8rem;
        font-weight: 600;
        color: rgba(15, 23, 42, 0.72);
      }
      .weekday.heading {
        font-size: 0.7rem;
        letter-spacing: 0.1em;
        color: rgba(15, 23, 42, 0.55);
      }
      .cell {
        aspect-ratio: 1 / 1;
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: #e2e8f0;
        color: #0f172a;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.04);
      }
      .cell:hover {
        transform: translateY(-2px);
        box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.1), 0 8px 18px rgba(15, 23, 42, 0.12);
      }
      .cell.weekend {
        opacity: 0.92;
      }
      .cell.today {
        box-shadow: inset 0 0 0 2px #f97316, 0 6px 14px rgba(249, 115, 22, 0.25);
      }
      .cell.peak:not(.today) {
        box-shadow: inset 0 0 0 2px rgba(59, 130, 246, 0.35);
      }
      .cell.empty {
        background: transparent;
        box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.35);
        opacity: 0.4;
      }
      .count {
        font-size: 1.6rem;
        font-weight: 600;
      }
      .date {
        font-size: 0.78rem;
        opacity: 0.76;
      }
      #legend {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        font-size: 0.85rem;
        color: rgba(15, 23, 42, 0.7);
        align-items: center;
      }
      .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .swatch {
        width: 28px;
        height: 12px;
        border-radius: 999px;
        display: inline-block;
        border: 1px solid rgba(15, 23, 42, 0.08);
      }

      /* Connect button styles */
      .connect-btn {
        display: inline-block;
        padding: 0.75rem 1.25rem;
        background: #4285f4;
        color: white;
        text-decoration: none;
        border-radius: 8px;
        font-weight: 500;
        font-size: 0.95rem;
        transition: background 0.2s ease;
        border: none;
        cursor: pointer;
      }
      .connect-btn:hover {
        background: #357ae8;
      }
      .connect-btn.apple {
        background: #000;
      }
      .connect-btn.apple:hover {
        background: #333;
      }
      .provider-buttons {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        align-items: center;
      }

      /* Blur and overlay styles */
      .blur-mode {
        filter: blur(4px);
        opacity: 0.4;
        pointer-events: none;
      }
      .connect-overlay {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 2.5rem;
        border-radius: 16px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        text-align: center;
        max-width: 420px;
        z-index: 100;
      }
      .connect-overlay h2 {
        margin: 0 0 1rem 0;
        font-size: 1.5rem;
      }
      .connect-overlay p {
        color: #64748b;
        margin: 0 0 1.5rem 0;
      }
      .connect-overlay .connect-btn {
        display: inline-block;
      }

      /* Settings button */
      .settings-btn {
        color: #0f172a;
        text-decoration: none;
        cursor: pointer;
        transition: opacity 0.2s ease;
      }
      .settings-btn:hover {
        opacity: 0.7;
      }

      /* CalDAV form styles */
      .caldav-form {
        display: none;
        text-align: left;
        margin-top: 1rem;
      }
      .caldav-form.active {
        display: block;
      }
      .caldav-form label {
        display: block;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
        font-weight: 500;
      }
      .caldav-form input {
        width: 100%;
        padding: 0.6rem;
        border: 1px solid #cbd5e1;
        border-radius: 6px;
        font-size: 0.95rem;
        margin-bottom: 0.75rem;
      }
      .caldav-form .hint {
        font-size: 0.8rem;
        color: #64748b;
        margin-top: -0.5rem;
        margin-bottom: 0.75rem;
      }
      .caldav-form button {
        width: 100%;
      }
      .back-link {
        color: #4285f4;
        cursor: pointer;
        font-size: 0.9rem;
        text-decoration: underline;
        margin-top: 1rem;
        display: inline-block;
      }

      @media (prefers-color-scheme: dark) {
        .connect-overlay {
          background: #1e293b;
          color: #f1f5f9;
        }
        .connect-overlay p {
          color: #94a3b8;
        }
        .caldav-form input {
          background: #334155;
          border-color: #475569;
          color: #f1f5f9;
        }
        .account-indicator {
          background: rgba(30, 41, 59, 0.9);
          border-color: rgba(255, 255, 255, 0.1);
          color: #6ee7b7;
        }
        .account-indicator a {
          color: #f1f5f9;
        }
      }
    </style>
  </head>
  <body>
    <div class="account-indicator" id="account-indicator" style="display: none;">
      <span id="account-email"></span>
      <a href="/settings.html" class="settings-btn">‚öôÔ∏è</a>
    </div>

    <main>
      <header>
        <h1>üåÜ Evening (18:00-22:00) ‚Ä¢ üåç <span id="timezone">Europe/London</span></h1>
        <span>‚Ä¢</span>
        <span id="last-updated">Loading‚Ä¶</span>
        <a href="https://house-availability.simonwisdom.workers.dev/auth/google/start"
           class="connect-btn"
           id="connect-button"
           style="display: none;">Connect Google Calendar</a>
      </header>

      <section id="heat-grid"></section>
      <section id="legend"></section>
    </main>

    <!-- Connect overlay shown when no data -->
    <div id="connect-overlay" class="connect-overlay" style="display: none;">
      <h2>Welcome to House Availability</h2>
      <p>Connect your calendar to see when housemates are free for events.</p>

      <div id="provider-selection" class="provider-buttons">
        <a class="connect-btn"
           id="overlay-connect-google"
           href="https://house-availability.simonwisdom.workers.dev/auth/google/start">Connect Google Calendar</a>
        <button class="connect-btn apple" id="overlay-connect-apple">Connect Apple Calendar</button>
      </div>

      <form id="caldav-form" class="caldav-form">
        <h3 style="margin-top: 0;">Apple Calendar Setup</h3>
        <p style="font-size: 0.9rem;">You'll need an app-specific password from your iCloud settings.</p>
        <a href="https://support.apple.com/en-us/102654" target="_blank" style="font-size: 0.85rem; color: #4285f4;">How to generate an app-specific password ‚Üí</a>

        <label style="margin-top: 1rem;">
          Your Name
          <input type="text" id="caldav-name" placeholder="John Doe" required />
        </label>

        <label>
          Apple ID Email
          <input type="email" id="caldav-email" placeholder="your.email@gmail.com or you@icloud.com" required />
          <div class="hint">Use whatever email address is your Apple ID</div>
        </label>

        <label>
          App-Specific Password
          <input type="password" id="caldav-password" placeholder="xxxx-xxxx-xxxx-xxxx" required />
          <div class="hint">Generate this from appleid.apple.com ‚Üí Sign-In & Security ‚Üí App-Specific Passwords</div>
        </label>

        <button type="submit" class="connect-btn apple">Connect Calendar</button>
        <a class="back-link" id="back-to-providers">‚Üê Back to provider selection</a>
      </form>
    </div>
    <script>
      const workerOrigin = (() => {
        const { protocol, hostname, port } = window.location;
        if (port === "8788") return `${protocol}//${hostname}:8787`;
        if (port === "64510" || hostname === "localhost") return `${protocol}//${hostname}:${port}`;
        return "https://house-availability.simonwisdom.workers.dev";
      })();

      const palette = [
        "#F1F5F9",
        "#D9E8FB",
        "#BED7F6",
        "#94BFF0",
        "#6DA5E8",
        "#4B89D9",
        "#306CC6",
        "#1B4DA0"
      ];
      const weekdayNames = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];

      const heatGrid = document.getElementById("heat-grid");
      const tzEl = document.getElementById("timezone");
      const lastUpdatedEl = document.getElementById("last-updated");
      const legend = document.getElementById("legend");
      const connectButton = document.getElementById("connect-button");
      const overlayConnectGoogle = document.getElementById("overlay-connect-google");
      const overlayConnectApple = document.getElementById("overlay-connect-apple");
      const providerSelection = document.getElementById("provider-selection");
      const caldavForm = document.getElementById("caldav-form");
      const backToProviders = document.getElementById("back-to-providers");

      if (connectButton) {
        connectButton.href = `${workerOrigin}/auth/google/start`;
      }
      if (overlayConnectGoogle) {
        overlayConnectGoogle.href = `${workerOrigin}/auth/google/start`;
      }

      // Handle Apple Calendar button click
      if (overlayConnectApple) {
        overlayConnectApple.addEventListener("click", () => {
          providerSelection.style.display = "none";
          caldavForm.classList.add("active");
        });
      }

      // Handle back to provider selection
      if (backToProviders) {
        backToProviders.addEventListener("click", (e) => {
          e.preventDefault();
          caldavForm.classList.remove("active");
          providerSelection.style.display = "flex";
        });
      }

      // Handle CalDAV form submission
      if (caldavForm) {
        caldavForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const displayName = document.getElementById("caldav-name").value.trim();
          const email = document.getElementById("caldav-email").value.trim();
          const password = document.getElementById("caldav-password").value.trim();

          try {
            const response = await fetch(`${workerOrigin}/auth/caldav/setup`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              credentials: "include",
              body: JSON.stringify({ displayName, email, password })
            });

            const result = await response.json();
            if (result.ok && result.redirectUrl) {
              window.location.href = result.redirectUrl;
            } else {
              alert(`Setup failed: ${result.error || "Unknown error"}`);
            }
          } catch (error) {
            console.error("CalDAV setup error:", error);
            alert("Failed to connect. Please check your credentials and try again.");
          }
        });
      }

      function formatDate(dateStr) {
        const date = new Date(`${dateStr}T00:00:00Z`);
        return date.toLocaleDateString(undefined, {
          month: "short",
          day: "numeric"
        });
      }

      function formatWeekLabel(dateStr) {
        const date = new Date(`${dateStr}T00:00:00Z`);
        return date.toLocaleDateString(undefined, {
          month: "short",
          day: "numeric"
        });
      }

      function formatRelative(datetime, timezone) {
        if (!datetime) return "Not synced";
        const date = new Date(datetime);
        const formatted = new Intl.DateTimeFormat(undefined, {
          dateStyle: "medium",
          timeStyle: "short",
          timeZone: timezone
        }).format(date);
        return `Updated ${formatted}`;
      }

      function getTodayIso(timezone) {
        return new Intl.DateTimeFormat("en-CA", { timeZone: timezone }).format(new Date());
      }

      function buildWeeks(days) {
        const weeks = [];
        let currentWeek = new Array(7).fill(null);

        days.forEach((day) => {
          const dateObj = new Date(`${day.date}T00:00:00Z`);
          const weekday = (dateObj.getUTCDay() + 6) % 7; // Monday-first

          if (currentWeek[weekday]) {
            weeks.push(currentWeek);
            currentWeek = new Array(7).fill(null);
          }

          currentWeek[weekday] = day;

          if (weekday === 6) {
            weeks.push(currentWeek);
            currentWeek = new Array(7).fill(null);
          }
        });

        if (currentWeek.some(Boolean)) {
          weeks.push(currentWeek);
        }

        return weeks;
      }

      function buildLegend(maxCount, scaleMax) {
        legend.innerHTML = "";
        const frag = document.createDocumentFragment();
        const capped = scaleMax || 0;

        for (let i = 0; i <= capped; i += 1) {
          const colorIdx = capped === 0 ? 0 : Math.round((i / capped) * (palette.length - 1));
          const span = document.createElement("span");
          span.className = "legend-item";
          span.innerHTML = `<span class="swatch" style="background:${palette[colorIdx]}"></span>${i} free`;
          frag.appendChild(span);
        }

        legend.appendChild(frag);
      }

      function renderHeatMap(data) {
        const timezone = data.timezone || "Europe/London";
        if (tzEl) tzEl.textContent = timezone;
        lastUpdatedEl.textContent = formatRelative(data.lastUpdatedIso, timezone);

        const weeks = buildWeeks(data.days);
        const todayIso = getTodayIso(timezone);
        const maxFree = data.days.reduce((acc, day) => Math.max(acc, day.freeCount), 0);
        const scaleMax = Math.max(maxFree, palette.length - 1);

        heatGrid.innerHTML = "";
        const frag = document.createDocumentFragment();

        const spacer = document.createElement("div");
        spacer.className = "week-label heading";
        frag.appendChild(spacer);

        weekdayNames.forEach((name) => {
          const head = document.createElement("div");
          head.className = "weekday heading";
          head.textContent = name;
          frag.appendChild(head);
        });

        weeks.forEach((week) => {
          const firstDay = week.find(Boolean);
          const label = document.createElement("div");
          label.className = "week-label";
          label.textContent = firstDay ? `Week of ${formatWeekLabel(firstDay.date)}` : "";
          frag.appendChild(label);

          week.forEach((day, idx) => {
            const cell = document.createElement("div");
            cell.className = "cell";

            if (!day) {
              cell.classList.add("empty");
              frag.appendChild(cell);
              return;
            }

            const colorIndex = scaleMax === 0 ? 0 : Math.round((day.freeCount / scaleMax) * (palette.length - 1));
            cell.style.background = palette[Math.min(colorIndex, palette.length - 1)];

            if (idx >= 5) cell.classList.add("weekend");
            if (day.date === todayIso) cell.classList.add("today");
            if (day.freeCount === maxFree && maxFree > 0) cell.classList.add("peak");

            const count = document.createElement("div");
            count.className = "count";
            count.textContent = day.freeCount.toString();

            const dateLabel = document.createElement("div");
            dateLabel.className = "date";
            dateLabel.textContent = formatDate(day.date);

            cell.append(count, dateLabel);
            frag.appendChild(cell);
          });
        });

        heatGrid.appendChild(frag);
        buildLegend(maxFree, scaleMax);
      }

      async function loadAvailability() {
        try {
          const response = await fetch(`${workerOrigin}/api/availability`, {
            credentials: "include"
          });

          if (!response.ok) {
            showConnectState();
            return;
          }

          const data = await response.json();

          // Check if we have any data
          if (!data.days || data.days.length === 0) {
            showConnectState();
            return;
          }

          // Check if all days have 0 free count (no users connected)
          const hasAnyData = data.days.some(day => day.freeCount > 0);
          if (!hasAnyData) {
            showConnectState();
            return;
          }

          // We have real data, show it
          hideConnectState();
          renderHeatMap(data);

          // Load user info to populate localStorage and show settings button
          await loadUserInfo();
          loadUserCalendars();
        } catch (error) {
          lastUpdatedEl.textContent = "Unable to load availability.";
          console.error(error);
          showConnectState();
        }
      }

      async function loadUserInfo() {
        try {
          const response = await fetch(`${workerOrigin}/api/user/info`, {
            credentials: "include"
          });

          if (!response.ok) return;

          const data = await response.json();
          if (data.ok && data.email) {
            localStorage.setItem('user_email', data.email);
          }
        } catch (error) {
          console.error('Failed to load user info:', error);
        }
      }

      async function loadUserCalendars() {
        const userEmail = localStorage.getItem('user_email');
        if (!userEmail) return;

        // Show account indicator
        const accountIndicator = document.getElementById('account-indicator');
        const accountEmailEl = document.getElementById('account-email');
        if (accountIndicator && accountEmailEl) {
          accountEmailEl.textContent = `‚úì ${userEmail}`;
          accountIndicator.style.display = 'flex';
        }

        try {
          const response = await fetch(`${workerOrigin}/api/user/calendars?email=${encodeURIComponent(userEmail)}`, {
            credentials: "include"
          });

          if (!response.ok) return;

          const data = await response.json();
          if (data.ok && data.calendars && data.calendars.length > 0) {
            // Update account indicator with calendar count
            if (accountEmailEl) {
              accountEmailEl.textContent = `‚úì ${userEmail} (${data.calendars.length} calendar${data.calendars.length !== 1 ? 's' : ''})`;
            }
          }
        } catch (error) {
          console.error('Failed to load user calendars:', error);
        }
      }

      function showConnectState() {
        // Show connect button in header
        document.getElementById('connect-button').style.display = 'inline-block';
        document.getElementById('last-updated').style.display = 'none';

        // Show overlay
        document.getElementById('connect-overlay').style.display = 'block';

        // Blur the grid
        document.getElementById('heat-grid').classList.add('blur-mode');
        document.getElementById('legend').classList.add('blur-mode');

        // Add some placeholder data for visual effect
        renderPlaceholderGrid();
      }

      function hideConnectState() {
        document.getElementById('connect-button').style.display = 'none';
        document.getElementById('last-updated').style.display = 'block';
        document.getElementById('connect-overlay').style.display = 'none';
        document.getElementById('heat-grid').classList.remove('blur-mode');
        document.getElementById('legend').classList.remove('blur-mode');
      }

      function renderPlaceholderGrid() {
        // Generate fake data for visual appeal
        const fakeDays = [];
        const today = new Date();
        for (let i = 0; i < 28; i++) {
          const date = new Date(today);
          date.setDate(date.getDate() + i);
          fakeDays.push({
            date: date.toISOString().split('T')[0],
            freeCount: Math.floor(Math.random() * 5)
          });
        }

        renderHeatMap({
          timezone: 'Europe/London',
          days: fakeDays,
          lastUpdatedIso: null
        });
      }

      loadAvailability();
    </script>
  </body>
</html>
