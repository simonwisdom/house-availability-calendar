<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>House Availability – Heat Map</title>
    <style>
      :root {
        color-scheme: light dark;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        padding: 0.75rem 1rem 4rem;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        background: radial-gradient(circle at top, rgba(26, 115, 232, 0.12), transparent 60%);
      }
      main {
        width: min(920px, 100%);
        display: grid;
        gap: 0.75rem;
      }
      header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
        font-size: 0.9rem;
      }
      header h1 {
        margin: 0;
        font-size: 1.15rem;
        font-weight: 500;
      }
      .timezone-label {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        color: rgba(15, 23, 42, 0.7);
      }
      .mobile-caption {
        display: none;
      }
      .last-updated-inline {
        display: inline-flex;
        align-items: center;
        margin-left: 0.4rem;
        font-size: 0.85rem;
        color: rgba(15, 23, 42, 0.7);
      }
      .last-updated-inline::before {
        content: "• ";
        margin-right: 0.05rem;
      }
      .header-separator {
        margin: 0 0.4rem;
        color: rgba(15, 23, 42, 0.35);
      }
      .header-meta {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        font-size: 0.85rem;
        color: rgba(15, 23, 42, 0.68);
      }
      .header-meta .mobile-caption {
        font-size: 0.7rem;
        letter-spacing: 0.04em;
        color: rgba(15, 23, 42, 0.55);
        font-weight: 600;
      }
      .account-indicator {
        position: fixed;
        top: 1rem;
        right: 1rem;
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(0, 0, 0, 0.1);
        padding: 0.5rem 0.75rem;
        border-radius: 8px;
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #047857;
      }
      .account-indicator a {
        color: #0f172a;
        text-decoration: none;
        margin-left: 0.25rem;
      }
      #heat-grid {
        display: grid;
        grid-template-columns: minmax(120px, 0.9fr) repeat(7, minmax(88px, 1fr));
        gap: 8px;
        align-items: stretch;
      }
      .week-label {
        font-size: 0.95rem;
        font-weight: 600;
        align-self: center;
        padding-right: 8px;
        color: rgba(15, 23, 42, 0.75);
      }
      .week-label.heading {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: rgba(15, 23, 42, 0.6);
      }
      .weekday {
        text-align: center;
        font-size: 0.8rem;
        font-weight: 600;
        color: rgba(15, 23, 42, 0.72);
      }
      .weekday.heading {
        font-size: 0.7rem;
        letter-spacing: 0.1em;
        color: rgba(15, 23, 42, 0.55);
      }
      .weekday-row,
      .week-group,
      .week-days {
        display: contents;
      }
      .day-name {
        display: none;
      }
      .cell {
        aspect-ratio: 1 / 1;
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: #e2e8f0;
        color: #0f172a;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.04);
      }
      .cell:hover {
        transform: translateY(-2px);
        box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.1), 0 8px 18px rgba(15, 23, 42, 0.12);
      }
      .cell.weekend {
        opacity: 0.92;
      }
      .cell.today {
        box-shadow: inset 0 0 0 2px #f97316, 0 6px 14px rgba(249, 115, 22, 0.25);
      }
      .cell.peak:not(.today) {
        box-shadow: inset 0 0 0 2px rgba(59, 130, 246, 0.35);
      }
      .cell.empty {
        background: transparent;
        box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.35);
        opacity: 0.4;
      }
      .count {
        font-size: 1.6rem;
        font-weight: 600;
      }
      .date {
        font-size: 0.78rem;
        opacity: 0.76;
      }
      #legend {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        font-size: 0.85rem;
        color: rgba(15, 23, 42, 0.7);
        align-items: center;
      }
      .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .swatch {
        width: 28px;
        height: 12px;
        border-radius: 999px;
        display: inline-block;
        border: 1px solid rgba(15, 23, 42, 0.08);
      }

      .mobile-footer {
        display: none;
      }

      /* Connect button styles */
      .connect-btn {
        display: inline-block;
        padding: 0.75rem 1.25rem;
        background: #4285f4;
        color: white;
        text-decoration: none;
        border-radius: 8px;
        font-weight: 500;
        font-size: 0.95rem;
        transition: background 0.2s ease;
        border: none;
        cursor: pointer;
      }
      .connect-btn:hover {
        background: #357ae8;
      }
      .connect-btn.apple {
        background: #000;
      }
      .connect-btn.apple:hover {
        background: #333;
      }
      .provider-buttons {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        align-items: center;
      }

      /* Blur and overlay styles */
      .blur-mode {
        filter: blur(4px);
        opacity: 0.4;
        pointer-events: none;
      }
      .connect-overlay {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 2.5rem;
        border-radius: 16px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        text-align: center;
        max-width: 420px;
        z-index: 100;
      }
      .connect-overlay h2 {
        margin: 0 0 1rem 0;
        font-size: 1.5rem;
      }
      .connect-overlay p {
        color: #64748b;
        margin: 0 0 1.5rem 0;
      }
      .connect-overlay .connect-btn {
        display: inline-block;
      }

      /* Settings button */
      .settings-btn {
        color: #0f172a;
        text-decoration: none;
        cursor: pointer;
        transition: opacity 0.2s ease;
      }
      .settings-btn:hover {
        opacity: 0.7;
      }

      /* CalDAV form styles */
      .caldav-form {
        display: none;
        text-align: left;
        margin-top: 1rem;
      }
      .caldav-form.active {
        display: block;
      }
      .caldav-form label {
        display: block;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
        font-weight: 500;
      }
      .caldav-form input {
        width: 100%;
        padding: 0.6rem;
        border: 1px solid #cbd5e1;
        border-radius: 6px;
        font-size: 0.95rem;
        margin-bottom: 0.75rem;
      }
      .caldav-form .hint {
        font-size: 0.8rem;
        color: #64748b;
        margin-top: -0.5rem;
        margin-bottom: 0.75rem;
      }
      .caldav-form button {
        width: 100%;
      }
      .back-link {
        color: #4285f4;
        cursor: pointer;
        font-size: 0.9rem;
        text-decoration: underline;
        margin-top: 1rem;
        display: inline-block;
      }

      /* Mobile view - streamlined week cards */
      @media (max-width: 768px) {
        body {
          padding: 0.5rem 0.75rem 1.25rem;
          justify-content: flex-start;
          align-items: stretch;
          overflow-y: hidden;
        }
        main {
          display: flex;
          flex-direction: column;
          width: 100%;
          max-width: 100%;
          height: calc(100vh - 1.75rem);
          min-height: 0;
          gap: 0.75rem;
        }
        header {
          flex-direction: column;
          align-items: flex-start;
          gap: 0.2rem;
          margin-bottom: 0.25rem;
        }
        header h1 {
          font-size: 1rem;
        }
        .timezone-label {
          display: none;
        }
        .last-updated-inline {
          display: none;
        }
        .header-separator {
          display: none;
        }
        #last-updated-text {
          display: none;
        }
        .header-meta {
          width: 100%;
          display: flex;
          flex-direction: column;
          align-items: flex-start;
          gap: 0.2rem;
          font-size: 1rem;
          color: rgba(15, 23, 42, 0.68);
        }
        .header-meta .mobile-caption {
          display: block;
          font-size: 1.12rem;
          font-weight: 600;
          letter-spacing: 0.01em;
          color: rgba(15, 23, 42, 0.82);
          line-height: 1.15;
        }
        .mobile-footer {
          display: flex;
          justify-content: center;
          align-items: center;
          font-size: 0.72rem;
          color: rgba(15, 23, 42, 0.55);
          padding-bottom: 0.25rem;
          flex-shrink: 0;
        }
        #heat-grid {
          flex: 1;
          display: flex;
          flex-direction: column;
          gap: 0.6rem;
          overflow: hidden;
          min-height: 0;
        }
        .weekday-row {
          display: none;
        }
        .week-group {
          display: none;
          padding: 0.85rem;
          border-radius: 14px;
          background: rgba(226, 232, 240, 0.82);
          border: 1px solid rgba(148, 163, 184, 0.35);
          box-shadow: 0 10px 22px rgba(15, 23, 42, 0.08);
          backdrop-filter: blur(6px);
        }
        .week-group.active {
          display: flex;
          flex-direction: column;
          gap: 0.5rem;
          flex: 1;
        }
        .week-group .week-label {
          font-size: 0.9rem;
          font-weight: 600;
          color: rgba(15, 23, 42, 0.8);
          margin-bottom: 0.1rem;
        }
        .week-days {
          flex: 1;
          display: flex;
          flex-direction: column;
          gap: 0.4rem;
        }
        .cell {
          flex: 0 0 auto;
          aspect-ratio: auto;
          width: 100%;
          padding: 0.55rem 0.7rem;
          flex-direction: row;
          align-items: center;
          gap: 0.65rem;
          border-radius: 12px;
          min-height: 0;
        }
        .cell.empty {
          display: none;
        }
        .day-name {
          display: block;
          font-size: 0.62rem;
          font-weight: 600;
          letter-spacing: 0.08em;
          text-transform: uppercase;
          color: rgba(15, 23, 42, 0.52);
          flex: 0 0 auto;
        }
        .count {
          font-size: 1.2rem;
          line-height: 1.2;
          color: rgba(15, 23, 42, 0.9);
        }
        .date {
          font-size: 0.7rem;
          opacity: 0.62;
          margin-left: auto;
        }
        .account-indicator {
          position: fixed;
          top: 0.6rem;
          right: 0.6rem;
          margin: 0;
          padding: 0.45rem;
          border-radius: 999px;
          font-size: 1.1rem;
          background: rgba(248, 250, 252, 0.9);
          border: 1px solid rgba(148, 163, 184, 0.35);
          box-shadow: 0 10px 20px rgba(15, 23, 42, 0.15);
          backdrop-filter: blur(12px);
          z-index: 30;
        }
        .account-indicator span {
          display: none;
        }
        .account-indicator .settings-btn {
          margin: 0;
          font-size: 1.1rem;
          line-height: 1;
        }
        #legend {
          display: none;
        }
        .week-nav {
          position: sticky;
          top: 0.35rem;
          z-index: 10;
          padding: 0.45rem 0.6rem;
          border-radius: 12px;
          background: rgba(248, 250, 252, 0.9);
          box-shadow: 0 12px 25px rgba(15, 23, 42, 0.12);
          backdrop-filter: blur(10px);
          margin-bottom: 0;
        }
        .week-nav .week-title {
          font-size: 0.95rem;
        }
      }
      .week-nav {
        display: none;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
        gap: 1rem;
      }
      .week-nav button {
        padding: 0.5rem 1rem;
        background: #4285f4;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: background 0.2s ease;
      }
      .week-nav button:hover {
        background: #357ae8;
      }
      .week-nav button:disabled {
        background: #cbd5e1;
        cursor: not-allowed;
      }
      .week-nav .week-title {
        font-weight: 600;
        font-size: 1rem;
      }
      @media (max-width: 768px) {
        .week-nav {
          display: flex;
        }
      }

      @media (prefers-color-scheme: dark) {
        .connect-overlay {
          background: #1e293b;
          color: #f1f5f9;
        }
        .connect-overlay p {
          color: #94a3b8;
        }
        .caldav-form input {
          background: #334155;
          border-color: #475569;
          color: #f1f5f9;
        }
        .account-indicator {
          background: rgba(30, 41, 59, 0.9);
          border-color: rgba(255, 255, 255, 0.1);
          color: #6ee7b7;
        }
        .account-indicator a {
          color: #f1f5f9;
        }
        .week-group {
          background: rgba(30, 41, 59, 0.85);
          border-color: rgba(71, 85, 105, 0.65);
          box-shadow: 0 16px 36px rgba(2, 6, 23, 0.55);
        }
        .week-group .week-label {
          color: rgba(226, 232, 240, 0.95);
        }
        .last-updated-inline {
          color: rgba(203, 213, 225, 0.8);
        }
        .header-separator {
          color: rgba(148, 163, 184, 0.5);
        }
        .timezone-label {
          color: rgba(203, 213, 225, 0.8);
        }
        .header-meta {
          color: rgba(203, 213, 225, 0.78);
        }
        .header-meta .mobile-caption {
          color: rgba(148, 163, 184, 0.7);
        }
        .mobile-footer {
          color: rgba(203, 213, 225, 0.72);
        }
        .day-name {
          color: rgba(148, 163, 184, 0.75);
        }
        .week-nav button {
          background: #334155;
        }
        .week-nav button:hover {
          background: #475569;
        }
        .week-nav button:disabled {
          background: #1e293b;
        }
        .week-nav {
          background: rgba(15, 23, 42, 0.92);
          box-shadow: 0 18px 32px rgba(2, 6, 23, 0.65);
        }
      }
    </style>
  </head>
  <body>
    <div class="account-indicator" id="account-indicator" style="display: none;">
      <span id="account-email"></span>
      <a href="/settings.html" class="settings-btn" aria-label="Account settings" title="Account settings">⚙️</a>
    </div>

    <main>
      <header>
        <h1>
          <span class="timezone-label">🌍 <span id="timezone">Europe/London</span></span>
          <span id="last-updated-inline" class="last-updated-inline">Loading…</span>
        </h1>
        <span class="header-separator">•</span>
        <span id="last-updated" class="header-meta">
          <span id="last-updated-text">Loading…</span>
          <span class="mobile-caption"># of housemates free from 6-10pm</span>
        </span>
        <a href="https://house-availability.simonwisdom.workers.dev/auth/google/start"
           class="connect-btn"
           id="connect-button"
           style="display: none;">Connect Google Calendar</a>
      </header>

      <div class="week-nav">
        <button id="prev-week">← Prev</button>
        <div class="week-title" id="week-title">Week of Oct 3</div>
        <button id="next-week">Next →</button>
      </div>
      <section id="heat-grid"></section>
      <section id="legend"></section>
      <footer id="mobile-footer" class="mobile-footer">
        <span id="last-updated-mobile">Loading…</span>
      </footer>
    </main>

    <!-- Connect overlay shown when no data -->
    <div id="connect-overlay" class="connect-overlay" style="display: none;">
      <h2>Welcome to House Availability</h2>
      <p>Connect your calendar to see when housemates are free for events.</p>

      <div id="provider-selection" class="provider-buttons">
        <a class="connect-btn"
           id="overlay-connect-google"
           href="https://house-availability.simonwisdom.workers.dev/auth/google/start">Connect Google Calendar</a>
        <button class="connect-btn apple" id="overlay-connect-apple">Connect Apple Calendar</button>
      </div>

      <form id="caldav-form" class="caldav-form">
        <h3 style="margin-top: 0;">Apple Calendar Setup</h3>
        <p style="font-size: 0.9rem;">You'll need an app-specific password from your iCloud settings.</p>
        <a href="https://support.apple.com/en-us/102654" target="_blank" style="font-size: 0.85rem; color: #4285f4;">How to generate an app-specific password →</a>

        <label style="margin-top: 1rem;">
          Your Name
          <input type="text" id="caldav-name" placeholder="John Doe" required />
        </label>

        <label>
          Apple ID Email
          <input type="email" id="caldav-email" placeholder="your.email@gmail.com or you@icloud.com" required />
          <div class="hint">Use whatever email address is your Apple ID</div>
        </label>

        <label>
          App-Specific Password
          <input type="password" id="caldav-password" placeholder="xxxx-xxxx-xxxx-xxxx" required />
          <div class="hint">Generate this from appleid.apple.com → Sign-In & Security → App-Specific Passwords</div>
        </label>

        <button type="submit" class="connect-btn apple">Connect Calendar</button>
        <a class="back-link" id="back-to-providers">← Back to provider selection</a>
      </form>
    </div>
    <script>
      const workerOrigin = (() => {
        const { protocol, hostname, port } = window.location;
        if (port === "8788") return `${protocol}//${hostname}:8787`;
        if (port === "64510" || hostname === "localhost") return `${protocol}//${hostname}:${port}`;
        return "https://house-availability.simonwisdom.workers.dev";
      })();

      const isLocalDevelopment = ["localhost", "127.0.0.1"].includes(window.location.hostname);

      function ensureSettingsVisibleForLocal() {
        if (!isLocalDevelopment) return;
        const indicator = document.getElementById('account-indicator');
        const accountEmailEl = document.getElementById('account-email');
        if (indicator && accountEmailEl && (indicator.style.display === 'none' || indicator.style.display === '')) {
          accountEmailEl.textContent = accountEmailEl.textContent || '✓ Local testing';
          indicator.style.display = 'flex';
        }
      }

      const palette = [
        "#F1F5F9",
        "#D9E8FB",
        "#BED7F6",
        "#94BFF0",
        "#6DA5E8",
        "#4B89D9",
        "#306CC6",
        "#1B4DA0"
      ];
      const weekdayNames = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];

      const heatGrid = document.getElementById("heat-grid");
      const tzEl = document.getElementById("timezone");
      const lastUpdatedContainer = document.getElementById("last-updated");
      const lastUpdatedTextEl = document.getElementById("last-updated-text");
      const lastUpdatedInlineEl = document.getElementById("last-updated-inline");
      const mobileFooter = document.getElementById("mobile-footer");
      const lastUpdatedMobileEl = document.getElementById("last-updated-mobile");
      const legend = document.getElementById("legend");
      const connectButton = document.getElementById("connect-button");
      const overlayConnectGoogle = document.getElementById("overlay-connect-google");
      const overlayConnectApple = document.getElementById("overlay-connect-apple");
      const providerSelection = document.getElementById("provider-selection");
      const caldavForm = document.getElementById("caldav-form");
      const backToProviders = document.getElementById("back-to-providers");
      const prevWeekBtn = document.getElementById("prev-week");
      const nextWeekBtn = document.getElementById("next-week");
      const weekTitle = document.getElementById("week-title");

      let currentWeekIndex = 0;
      let totalWeeks = 0;

      if (connectButton) {
        connectButton.href = `${workerOrigin}/auth/google/start`;
      }
      if (overlayConnectGoogle) {
        overlayConnectGoogle.href = `${workerOrigin}/auth/google/start`;
      }

      // Handle Apple Calendar button click
      if (overlayConnectApple) {
        overlayConnectApple.addEventListener("click", () => {
          providerSelection.style.display = "none";
          caldavForm.classList.add("active");
        });
      }

      // Handle back to provider selection
      if (backToProviders) {
        backToProviders.addEventListener("click", (e) => {
          e.preventDefault();
          caldavForm.classList.remove("active");
          providerSelection.style.display = "flex";
        });
      }

      // Handle CalDAV form submission
      if (caldavForm) {
        caldavForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const displayName = document.getElementById("caldav-name").value.trim();
          const email = document.getElementById("caldav-email").value.trim();
          const password = document.getElementById("caldav-password").value.trim();

          try {
            const response = await fetch(`${workerOrigin}/auth/caldav/setup`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              credentials: "include",
              body: JSON.stringify({ displayName, email, password })
            });

            const result = await response.json();
            if (result.ok && result.redirectUrl) {
              window.location.href = result.redirectUrl;
            } else {
              alert(`Setup failed: ${result.error || "Unknown error"}`);
            }
          } catch (error) {
            console.error("CalDAV setup error:", error);
            alert("Failed to connect. Please check your credentials and try again.");
          }
        });
      }

      function setLastUpdatedDisplay(text) {
        const content = text || 'Loading…';
        if (lastUpdatedTextEl) {
          lastUpdatedTextEl.textContent = content;
        }
        if (lastUpdatedInlineEl) {
          lastUpdatedInlineEl.textContent = content;
        }
        if (lastUpdatedMobileEl) {
          lastUpdatedMobileEl.textContent = content;
        }
      }

      function formatDate(dateStr) {
        const date = new Date(`${dateStr}T00:00:00Z`);
        return date.toLocaleDateString(undefined, {
          month: "short",
          day: "numeric"
        });
      }

      function formatWeekLabel(dateStr) {
        const date = new Date(`${dateStr}T00:00:00Z`);
        return date.toLocaleDateString(undefined, {
          month: "short",
          day: "numeric"
        });
      }

      function formatRelative(datetime, timezone) {
        if (!datetime) return "Not synced";
        const date = new Date(datetime);
        const formatted = new Intl.DateTimeFormat(undefined, {
          dateStyle: "medium",
          timeStyle: "short",
          timeZone: timezone
        }).format(date);
        return `Updated ${formatted}`;
      }

      function getTodayIso(timezone) {
        return new Intl.DateTimeFormat("en-CA", { timeZone: timezone }).format(new Date());
      }

      function buildWeeks(days) {
        const weeks = [];
        let currentWeek = new Array(7).fill(null);

        days.forEach((day) => {
          const dateObj = new Date(`${day.date}T00:00:00Z`);
          const weekday = (dateObj.getUTCDay() + 6) % 7; // Monday-first

          if (currentWeek[weekday]) {
            weeks.push(currentWeek);
            currentWeek = new Array(7).fill(null);
          }

          currentWeek[weekday] = day;

          if (weekday === 6) {
            weeks.push(currentWeek);
            currentWeek = new Array(7).fill(null);
          }
        });

        if (currentWeek.some(Boolean)) {
          weeks.push(currentWeek);
        }

        return weeks;
      }

      function buildLegend(maxCount, scaleMax) {
        legend.innerHTML = "";
        const frag = document.createDocumentFragment();
        const capped = scaleMax || 0;

        for (let i = 0; i <= capped; i += 1) {
          const colorIdx = capped === 0 ? 0 : Math.round((i / capped) * (palette.length - 1));
          const span = document.createElement("span");
          span.className = "legend-item";
          span.innerHTML = `<span class="swatch" style="background:${palette[colorIdx]}"></span>${i} free`;
          frag.appendChild(span);
        }

        legend.appendChild(frag);
      }

      function updateWeekNavigation() {
        if (prevWeekBtn && nextWeekBtn) {
          prevWeekBtn.disabled = currentWeekIndex === 0;
          nextWeekBtn.disabled = currentWeekIndex >= totalWeeks - 1;
        }

        // Update visible week on mobile
        const allElements = document.querySelectorAll('.week-row');
        allElements.forEach((el) => {
          const weekIdx = parseInt(el.dataset.weekIndex);
          if (weekIdx === currentWeekIndex) {
            el.classList.add('active');
          } else {
            el.classList.remove('active');
          }
        });
      }

      function renderHeatMap(data) {
        const timezone = data.timezone || "Europe/London";
        if (tzEl) tzEl.textContent = timezone;
        setLastUpdatedDisplay(formatRelative(data.lastUpdatedIso, timezone));

        const weeks = buildWeeks(data.days);
        totalWeeks = weeks.length;

        // Find the week containing today
        const todayIso = getTodayIso(timezone);
        currentWeekIndex = weeks.findIndex(week =>
          week.some(day => day && day.date === todayIso)
        );
        if (currentWeekIndex === -1) currentWeekIndex = 0;

        const maxFree = data.days.reduce((acc, day) => Math.max(acc, day.freeCount), 0);
        const scaleMax = Math.max(maxFree, palette.length - 1);

        heatGrid.innerHTML = "";
        const frag = document.createDocumentFragment();

        const headerRow = document.createElement("div");
        headerRow.className = "weekday-row";

        const spacer = document.createElement("div");
        spacer.className = "week-label heading";
        headerRow.appendChild(spacer);

        weekdayNames.forEach((name) => {
          const head = document.createElement("div");
          head.className = "weekday heading";
          head.textContent = name;
          headerRow.appendChild(head);
        });

        frag.appendChild(headerRow);

        weeks.forEach((week, weekIdx) => {
          const firstDay = week.find(Boolean);

          const group = document.createElement("div");
          group.className = "week-group week-row";
          group.dataset.weekIndex = weekIdx;

          const label = document.createElement("div");
          label.className = "week-label";
          label.textContent = firstDay ? `Week of ${formatWeekLabel(firstDay.date)}` : "";
          group.appendChild(label);

          const daysWrap = document.createElement("div");
          daysWrap.className = "week-days";
          group.appendChild(daysWrap);

          week.forEach((day, idx) => {
            const cell = document.createElement("div");
            cell.className = "cell";
            cell.dataset.weekIndex = weekIdx;

            if (!day) {
              cell.classList.add("empty");
              daysWrap.appendChild(cell);
              return;
            }

            const colorIndex = scaleMax === 0 ? 0 : Math.round((day.freeCount / scaleMax) * (palette.length - 1));
            cell.style.background = palette[Math.min(colorIndex, palette.length - 1)];

            if (idx >= 5) cell.classList.add("weekend");
            if (day.date === todayIso) cell.classList.add("today");
            if (day.freeCount === maxFree && maxFree > 0) cell.classList.add("peak");

            const dayName = document.createElement("div");
            dayName.className = "day-name";
            dayName.textContent = weekdayNames[idx];

            const count = document.createElement("div");
            count.className = "count";
            count.textContent = day.freeCount.toString();

            const dateLabel = document.createElement("div");
            dateLabel.className = "date";
            dateLabel.textContent = formatDate(day.date);

            cell.append(dayName, count, dateLabel);
            daysWrap.appendChild(cell);
          });

          frag.appendChild(group);
        });

        heatGrid.appendChild(frag);
        buildLegend(maxFree, scaleMax);

        // Update week title
        const currentWeek = weeks[currentWeekIndex];
        const firstDay = currentWeek ? currentWeek.find(Boolean) : null;
        if (weekTitle && firstDay) {
          weekTitle.textContent = `Week of ${formatWeekLabel(firstDay.date)}`;
        }

        updateWeekNavigation();
      }

      async function loadAvailability() {
        try {
          const response = await fetch(`${workerOrigin}/api/availability`, {
            credentials: "include"
          });

          if (!response.ok) {
            showConnectState();
            return;
          }

          const data = await response.json();

          // Check if we have any data
          if (!data.days || data.days.length === 0) {
            showConnectState();
            return;
          }

          // Check if all days have 0 free count (no users connected)
          const hasAnyData = data.days.some(day => day.freeCount > 0);
          if (!hasAnyData) {
            showConnectState();
            return;
          }

          // We have real data, show it
          hideConnectState();
          renderHeatMap(data);

          // Load user info to populate localStorage and show settings button
          await loadUserInfo();
          loadUserCalendars();
        } catch (error) {
          setLastUpdatedDisplay("Unable to load availability.");
          console.error(error);
          showConnectState();
        }
      }

      async function loadUserInfo() {
        try {
          const response = await fetch(`${workerOrigin}/api/user/info`, {
            credentials: "include"
          });

          if (!response.ok) return;

          const data = await response.json();
          if (data.ok && data.email) {
            localStorage.setItem('user_email', data.email);
          }
        } catch (error) {
          console.error('Failed to load user info:', error);
        }
      }

      async function loadUserCalendars() {
        const userEmail = localStorage.getItem('user_email');
        if (!userEmail) return;

        // Show account indicator
        const accountIndicator = document.getElementById('account-indicator');
        const accountEmailEl = document.getElementById('account-email');
        if (accountIndicator && accountEmailEl) {
          accountEmailEl.textContent = `✓ ${userEmail}`;
          accountIndicator.style.display = 'flex';
        }

        try {
          const response = await fetch(`${workerOrigin}/api/user/calendars?email=${encodeURIComponent(userEmail)}`, {
            credentials: "include"
          });

          if (!response.ok) return;

          const data = await response.json();
          if (data.ok && data.calendars && data.calendars.length > 0) {
            // Update account indicator with calendar count
            if (accountEmailEl) {
              accountEmailEl.textContent = `✓ ${userEmail} (${data.calendars.length} calendar${data.calendars.length !== 1 ? 's' : ''})`;
            }
          }
        } catch (error) {
          console.error('Failed to load user calendars:', error);
        }
      }

      function showConnectState() {
        // Show connect button in header
        if (connectButton) {
          connectButton.style.display = 'inline-block';
        }
        if (lastUpdatedContainer) {
          lastUpdatedContainer.style.display = 'none';
        }
        if (mobileFooter) {
          mobileFooter.style.display = 'none';
        }

        // Show overlay
        document.getElementById('connect-overlay').style.display = 'block';

        // Blur the grid
        if (heatGrid) {
          heatGrid.classList.add('blur-mode');
        }
        if (legend) {
          legend.classList.add('blur-mode');
        }

        ensureSettingsVisibleForLocal();

        // Add some placeholder data for visual effect
        renderPlaceholderGrid();
      }

      function hideConnectState() {
        if (connectButton) {
          connectButton.style.display = 'none';
        }
        if (lastUpdatedContainer) {
          lastUpdatedContainer.style.display = '';
        }
        if (mobileFooter) {
          mobileFooter.style.display = '';
        }
        document.getElementById('connect-overlay').style.display = 'none';
        if (heatGrid) {
          heatGrid.classList.remove('blur-mode');
        }
        if (legend) {
          legend.classList.remove('blur-mode');
        }

        ensureSettingsVisibleForLocal();
      }

      function renderPlaceholderGrid() {
        // Generate fake data for visual appeal
        const fakeDays = [];
        const today = new Date();
        for (let i = 0; i < 28; i++) {
          const date = new Date(today);
          date.setDate(date.getDate() + i);
          fakeDays.push({
            date: date.toISOString().split('T')[0],
            freeCount: Math.floor(Math.random() * 5)
          });
        }

        renderHeatMap({
          timezone: 'Europe/London',
          days: fakeDays,
          lastUpdatedIso: null
        });
      }

      // Week navigation handlers
      if (prevWeekBtn) {
        prevWeekBtn.addEventListener('click', () => {
          if (currentWeekIndex > 0) {
            currentWeekIndex--;
            const firstCell = document.querySelector(`[data-week-index="${currentWeekIndex}"].cell:not(.empty)`);
            if (weekTitle && firstCell) {
              const dateText = firstCell.querySelector('.date').textContent;
              weekTitle.textContent = `Week of ${dateText}`;
            }
            updateWeekNavigation();
          }
        });
      }

      if (nextWeekBtn) {
        nextWeekBtn.addEventListener('click', () => {
          if (currentWeekIndex < totalWeeks - 1) {
            currentWeekIndex++;
            const firstCell = document.querySelector(`[data-week-index="${currentWeekIndex}"].cell:not(.empty)`);
            if (weekTitle && firstCell) {
              const dateText = firstCell.querySelector('.date').textContent;
              weekTitle.textContent = `Week of ${dateText}`;
            }
            updateWeekNavigation();
          }
        });
      }

      loadAvailability();
      ensureSettingsVisibleForLocal();
    </script>
  </body>
</html>
