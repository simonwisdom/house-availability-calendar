<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>House Availability ‚Äì Heat Map</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üè†</text></svg>" />
    <style>
      :root {
        color-scheme: light dark;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        padding: 0.75rem 1rem;
        min-height: 100vh;
        height: 100vh;
        display: flex;
        justify-content: center;
        background: radial-gradient(circle at top, rgba(26, 115, 232, 0.12), transparent 60%);
        overflow: hidden;
      }
      main {
        width: min(920px, 100%);
        height: 100%;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }
      header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
        flex-shrink: 0;
      }
      header h1 {
        margin: 0;
        font-size: 1.15rem;
        font-weight: 500;
      }
      .timezone-label {
        display: none;
      }
      .mobile-caption {
        display: block;
        font-size: 1.15rem;
        font-weight: 500;
        color: rgba(15, 23, 42, 0.85);
      }
      .last-updated-inline {
        display: none;
      }
      .header-separator {
        margin: 0 0.4rem;
        color: rgba(15, 23, 42, 0.35);
      }
      .header-meta {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        font-size: 0.85rem;
        color: rgba(15, 23, 42, 0.68);
      }
      .header-meta .mobile-caption {
        font-size: 1.15rem;
        font-weight: 500;
        color: rgba(15, 23, 42, 0.85);
      }
      #last-updated-text {
        display: none;
      }
      .account-indicator {
        position: fixed;
        top: 1rem;
        right: 1rem;
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(0, 0, 0, 0.1);
        padding: 0.5rem 0.75rem;
        border-radius: 8px;
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #047857;
      }
      .account-indicator a {
        color: #0f172a;
        text-decoration: none;
        margin-left: 0.25rem;
      }
      #heat-grid {
        display: grid;
        grid-template-columns: minmax(120px, 0.9fr) repeat(7, minmax(88px, 1fr));
        gap: 8px;
        align-items: start;
        flex: 1;
        overflow: visible;
        min-height: 0;
        align-content: start;
      }
      .week-label {
        font-size: 0.95rem;
        font-weight: 600;
        align-self: center;
        padding-right: 8px;
        color: rgba(15, 23, 42, 0.75);
      }
      .week-label.heading {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: rgba(15, 23, 42, 0.6);
      }
      .weekday {
        text-align: center;
        font-size: 0.8rem;
        font-weight: 600;
        color: rgba(15, 23, 42, 0.72);
      }
      .weekday.heading {
        font-size: 0.7rem;
        letter-spacing: 0.1em;
        color: rgba(15, 23, 42, 0.55);
      }
      .weekday-row,
      .week-group,
      .week-days {
        display: contents;
      }
      .day-name {
        display: none;
      }
      .cell {
        width: 100%;
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        align-items: stretch;
        justify-content: space-between;
        background: #ffffff;
        color: #0f172a;
        border: 1px solid rgba(15, 23, 42, 0.08);
        transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
        box-shadow: 0 1px 2px rgba(15, 23, 42, 0.04);
        padding: 0.6rem 0.55rem;
        min-height: 0;
        min-width: 0;
        position: relative;
        overflow: visible;
        box-sizing: border-box;
      }
      .cell:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 18px rgba(15, 23, 42, 0.12);
      }
      .cell.weekend {
        opacity: 0.92;
      }
      .cell.empty {
        background: transparent;
        box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.35);
        opacity: 0.4;
      }
      .cell.placeholder,
      .cell.past-day {
        background: rgba(226, 232, 240, 0.6);
        border-color: rgba(148, 163, 184, 0.4);
        box-shadow: none;
        color: rgba(71, 85, 105, 0.85);
      }
      .cell.past-day .day-name,
      .cell.placeholder .day-name {
        color: rgba(100, 116, 139, 0.85);
      }
      .count {
        display: none;
      }
      .date {
        font-size: 0.72rem;
        opacity: 0.6;
        margin-top: 0.45rem;
        text-align: center;
      }
      .segment-wrap {
        position: relative;
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 0;
        width: 100%;
        flex: 1;
        box-sizing: border-box;
      }
      .segment-wrap::before {
        content: "";
        position: absolute;
        top: 10%;
        bottom: 10%;
        left: 50%;
        width: 1px;
        background: rgba(148, 163, 184, 0.5);
        transform: translateX(-50%);
        pointer-events: none;
      }
      .segment {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        gap: 0.25rem;
        padding: 0.35rem 0.25rem;
        border-radius: 0;
        border: 1px solid transparent;
        background: rgba(148, 163, 184, 0.18);
        box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.05);
        transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
        cursor: pointer;
        position: relative;
        height: 100%;
        width: 100%;
        box-sizing: border-box;
      }
      .segment:first-child {
        border-top-left-radius: 10px;
        border-bottom-left-radius: 10px;
      }
      .segment:last-child {
        border-top-right-radius: 10px;
        border-bottom-right-radius: 10px;
        border-left: 1px solid rgba(148, 163, 184, 0.3);
      }
      .segment-label {
        font-size: 0.62rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        opacity: 0.78;
      }
      .segment-count {
        font-size: 1.05rem;
        font-weight: 600;
        color: inherit;
      }
      .initials-container {
        display: none;
      }
      .initials-circle {
        display: none;
      }
      .overflow-indicator {
        display: none;
      }
      .empty-indicator {
        display: none;
      }
      .segment-available {
        background: rgba(74, 222, 128, 0.18);
        border-color: rgba(34, 197, 94, 0.35);
        color: #166534;
      }
      .segment-available .segment-label {
        opacity: 0.85;
      }
      .segment-empty {
        background: rgba(148, 163, 184, 0.16);
        border-color: rgba(148, 163, 184, 0.3);
        color: rgba(15, 23, 42, 0.65);
      }
      .segment-empty .segment-label {
        opacity: 0.7;
      }
      .cell.placeholder .segment,
      .cell.past-day .segment {
        background: rgba(148, 163, 184, 0.14);
        border-color: rgba(148, 163, 184, 0.28);
        color: rgba(71, 85, 105, 0.7);
      }
      .cell.placeholder .segment-count,
      .cell.past-day .segment-count {
        color: inherit;
      }
      .segment:focus-visible {
        outline: 2px solid rgba(59, 130, 246, 0.45);
        outline-offset: 2px;
      }
      .segment.tooltip-open {
        border-color: rgba(59, 130, 246, 0.55);
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.15);
      }
      .segment-tooltip {
        position: fixed;
        min-width: 200px;
        max-width: 260px;
        background: #ffffff;
        border: 1px solid rgba(15, 23, 42, 0.12);
        box-shadow: 0 16px 32px rgba(15, 23, 42, 0.18);
        border-radius: 10px;
        padding: 0.6rem 0.7rem;
        z-index: 1000;
      }
      .segment-tooltip::before {
        content: "";
        position: absolute;
        left: 50%;
        transform: translateX(-50%) rotate(45deg);
        width: 12px;
        height: 12px;
        background: inherit;
      }
      .segment-tooltip--above::before {
        bottom: -6px;
        border-right: 1px solid rgba(15, 23, 42, 0.12);
        border-bottom: 1px solid rgba(15, 23, 42, 0.12);
      }
      .segment-tooltip--below::before {
        top: -6px;
        border-left: 1px solid rgba(15, 23, 42, 0.12);
        border-top: 1px solid rgba(15, 23, 42, 0.12);
      }
      .segment-tooltip-body {
        font-size: 0.78rem;
        color: rgba(15, 23, 42, 0.75);
      }
      .segment-tooltip-list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 0.3rem;
        max-height: 160px;
        overflow-y: auto;
      }
      .segment-tooltip-list li {
        display: grid;
        gap: 0.15rem;
      }
      .segment-tooltip-primary {
        font-weight: 600;
        color: rgba(15, 23, 42, 0.88);
      }
      .segment-tooltip-secondary {
        display: none;
      }
      #legend {
        display: none;
      }
      .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .swatch {
        width: 28px;
        height: 12px;
        border-radius: 999px;
        display: inline-block;
        border: 1px solid rgba(15, 23, 42, 0.08);
      }

      .mobile-footer {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 0.85rem;
        color: rgba(15, 23, 42, 0.65);
        padding-top: 0.5rem;
        flex-shrink: 0;
      }

      /* Connect button styles */
      .connect-btn {
        display: inline-block;
        padding: 0.75rem 1.25rem;
        background: #4285f4;
        color: white;
        text-decoration: none;
        border-radius: 8px;
        font-weight: 500;
        font-size: 0.95rem;
        transition: background 0.2s ease;
        border: none;
        cursor: pointer;
      }
      .connect-btn:hover {
        background: #357ae8;
      }
      .connect-btn.outlook {
        background: #0078d4;
      }
      .connect-btn.outlook:hover {
        background: #106ebe;
      }
      .connect-btn.apple {
        background: #000;
      }
      .connect-btn.apple:hover {
        background: #333;
      }
      .provider-buttons {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        align-items: center;
      }

      /* Blur and overlay styles */
      .blur-mode {
        filter: blur(4px);
        opacity: 0.4;
        pointer-events: none;
      }
      .connect-overlay {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 2.5rem;
        border-radius: 16px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        text-align: center;
        max-width: 420px;
        z-index: 100;
      }
      .connect-overlay h2 {
        margin: 0 0 1rem 0;
        font-size: 1.5rem;
      }
      .connect-overlay p {
        color: #64748b;
        margin: 0 0 1.5rem 0;
      }
      .connect-overlay .connect-btn {
        display: inline-block;
      }

      /* Settings button */
      .settings-btn {
        color: #0f172a;
        text-decoration: none;
        cursor: pointer;
        transition: opacity 0.2s ease;
      }
      .settings-btn:hover {
        opacity: 0.7;
      }

      /* CalDAV form styles */
      .caldav-form {
        display: none;
        text-align: left;
        margin-top: 1rem;
      }
      .caldav-form.active {
        display: block;
      }
      .caldav-form label {
        display: block;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
        font-weight: 500;
      }
      .caldav-form input {
        width: 100%;
        padding: 0.6rem;
        border: 1px solid #cbd5e1;
        border-radius: 6px;
        font-size: 0.95rem;
        margin-bottom: 0.75rem;
      }
      .caldav-form .hint {
        font-size: 0.8rem;
        color: #64748b;
        margin-top: -0.5rem;
        margin-bottom: 0.75rem;
      }
      .caldav-form button {
        width: 100%;
      }
      .back-link {
        color: #4285f4;
        cursor: pointer;
        font-size: 0.9rem;
        text-decoration: underline;
        margin-top: 1rem;
        display: inline-block;
      }

      /* Mobile view - condensed table */
      @media (max-width: 768px) {
        body {
          padding: 0.4rem 0.6rem 0.4rem;
          justify-content: flex-start;
          align-items: stretch;
          overflow: hidden;
          min-height: 100vh;
        }
        main {
          display: flex;
          flex-direction: column;
          width: 100%;
          max-width: 100%;
          max-height: 95vh;
          min-height: 0;
          gap: 0.3rem;
        }
        header {
          flex-direction: column;
          align-items: flex-start;
          gap: 0.1rem;
          margin-bottom: 0.1rem;
        }
        header h1 {
          font-size: 0.98rem;
        }
        .timezone-label,
        .last-updated-inline,
        .header-separator,
        #last-updated-text {
          display: none;
        }
        .header-meta {
          width: 100%;
          display: flex;
          flex-direction: column;
          align-items: flex-start;
          gap: 0.2rem;
          font-size: 0.95rem;
          color: rgba(15, 23, 42, 0.7);
        }
        .header-meta .mobile-caption {
          display: block;
          font-size: 1.08rem;
          font-weight: 600;
          letter-spacing: 0.01em;
          color: rgba(15, 23, 42, 0.82);
          line-height: 1.12;
        }
        .mobile-footer {
          display: flex;
          justify-content: center;
          align-items: center;
          font-size: 0.65rem;
          color: rgba(15, 23, 42, 0.5);
          padding: 0.25rem 0 0 0;
          flex-shrink: 0;
        }
        #heat-grid {
          flex: 1;
          display: flex;
          flex-direction: column;
          gap: 0.25rem;
          overflow: hidden;
          min-height: 0;
        }
        .weekday-row {
          display: none;
        }
        .week-group {
          display: none;
          padding: 0.5rem;
          border-radius: 12px;
          background: rgba(226, 232, 240, 0.78);
          border: 1px solid rgba(148, 163, 184, 0.35);
          box-shadow: 0 8px 18px rgba(15, 23, 42, 0.08);
          backdrop-filter: blur(6px);
        }
        .week-group.active {
          display: flex;
          flex-direction: column;
          gap: 0.12rem;
          flex: 1;
          min-height: 0;
          align-self: stretch;
        }
        .week-group .week-label {
          display: none;
        }
        .mobile-segment-headers {
          display: grid;
          grid-template-columns: 0.9fr repeat(2, minmax(0, 1fr));
          gap: 0.3rem;
          padding: 0 0.35rem;
          font-size: 0.55rem;
          letter-spacing: 0.08em;
          text-transform: uppercase;
          color: rgba(15, 23, 42, 0.58);
        }
        .mobile-segment-headers span {
          text-align: center;
        }
        .mobile-segment-headers span:first-child {
          justify-self: flex-start;
          text-align: left;
        }
        .week-days {
          flex: 1;
          display: grid;
          grid-auto-rows: minmax(0, 1fr);
          gap: 0.12rem;
          min-height: 0;
        }
        .cell {
          display: grid;
          grid-template-columns: 0.95fr repeat(2, minmax(0, 1fr));
          gap: 0.25rem;
          align-items: stretch;
          padding: 0.35rem 0.4rem;
          border-radius: 10px;
          min-height: 0;
        }
        .cell.empty {
          display: none;
        }
        .day-name {
          display: block;
          grid-column: 1;
          align-self: center;
          font-size: 0.72rem;
          font-weight: 600;
          letter-spacing: 0.02em;
          text-transform: none;
          color: rgba(15, 23, 42, 0.72);
        }
        .count {
          display: none;
        }
        .segment-wrap {
          position: static;
          grid-column: 2 / span 2;
          display: grid;
          grid-template-columns: repeat(2, minmax(0, 1fr));
          gap: 0.2rem;
          align-items: stretch;
        }
        .segment-wrap::before {
          display: none;
        }
        .segment {
          min-height: 0;
          padding: 0.3rem 0.25rem;
          justify-content: center;
          text-align: center;
          border-radius: 10px;
          border-left: none;
        }
        .segment:first-child,
        .segment:last-child {
          border-radius: 10px;
        }
        .segment-label {
          display: none;
        }
        .segment-count {
          font-size: 0.9rem;
          font-weight: 700;
        }
        .initials-container {
          display: flex;
          flex-wrap: wrap;
          gap: 0.15rem;
          justify-content: flex-start;
          align-items: flex-start;
          align-content: flex-start;
          min-height: auto;
          width: 100%;
        }
        .initials-circle {
          display: inline-flex;
          width: 16px;
          height: 16px;
          border-radius: 50%;
          align-items: center;
          justify-content: center;
          font-size: 0.5rem;
          font-weight: 700;
          color: white;
          text-transform: uppercase;
          letter-spacing: -0.02em;
          flex-shrink: 0;
          box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
          border: 1px solid rgba(255, 255, 255, 0.4);
        }
        .overflow-indicator {
          display: inline-flex;
          background: rgba(100, 116, 139, 0.85) !important;
          font-size: 0.48rem;
        }
        .empty-indicator {
          display: block;
          font-size: 0.85rem;
          color: rgba(15, 23, 42, 0.35);
          font-weight: 400;
          text-align: center;
        }
        .date {
          display: none;
        }
        .account-indicator {
          position: fixed;
          top: 0.6rem;
          right: 0.6rem;
          margin: 0;
          padding: 0.4rem;
          border-radius: 16px;
          font-size: 1.05rem;
          background: rgba(248, 250, 252, 0.9);
          border: 1px solid rgba(148, 163, 184, 0.35);
          box-shadow: 0 10px 20px rgba(15, 23, 42, 0.14);
          backdrop-filter: blur(12px);
          z-index: 30;
        }
        .account-indicator span {
          display: none;
        }
        .account-indicator .settings-btn {
          margin: 0;
          font-size: 1.05rem;
          line-height: 1;
        }
        #legend {
          display: none;
        }
        .week-nav {
          position: sticky;
          top: 0.35rem;
          z-index: 10;
          padding: 0.35rem 0.5rem;
          border-radius: 12px;
          background: rgba(248, 250, 252, 0.9);
          box-shadow: 0 12px 22px rgba(15, 23, 42, 0.1);
          backdrop-filter: blur(10px);
          margin-bottom: 0;
        }
        .week-nav .week-title {
          font-size: 0.92rem;
        }
      }
      .week-nav {
        display: none;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
        gap: 1rem;
      }
      .week-nav button {
        padding: 0.5rem 1rem;
        background: #4285f4;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: background 0.2s ease;
      }
      .week-nav button:hover {
        background: #357ae8;
      }
      .week-nav button:disabled {
        background: #cbd5e1;
        cursor: not-allowed;
      }
      .week-nav .week-title {
        font-weight: 600;
        font-size: 1rem;
      }
      @media (max-width: 768px) {
        .week-nav {
          display: flex;
        }
      }

      @media (prefers-color-scheme: dark) {
        .connect-overlay {
          background: #1e293b;
          color: #f1f5f9;
        }
        .connect-overlay p {
          color: #94a3b8;
        }
        .caldav-form input {
          background: #334155;
          border-color: #475569;
          color: #f1f5f9;
        }
        .account-indicator {
          background: rgba(30, 41, 59, 0.9);
          border-color: rgba(255, 255, 255, 0.1);
          color: #6ee7b7;
        }
        .account-indicator a {
          color: #f1f5f9;
        }
        .week-group {
          background: rgba(30, 41, 59, 0.85);
          border-color: rgba(71, 85, 105, 0.65);
          box-shadow: 0 16px 36px rgba(2, 6, 23, 0.55);
        }
        .week-group .week-label {
          color: rgba(226, 232, 240, 0.95);
        }
        .last-updated-inline {
          color: rgba(203, 213, 225, 0.8);
        }
        .header-separator {
          color: rgba(148, 163, 184, 0.5);
        }
        .timezone-label {
          color: rgba(203, 213, 225, 0.8);
        }
        .header-meta {
          color: rgba(203, 213, 225, 0.78);
        }
        .header-meta .mobile-caption {
          color: rgba(226, 232, 240, 0.9);
        }
        .mobile-footer {
          color: rgba(148, 163, 184, 0.8);
        }
        .day-name {
          color: rgba(148, 163, 184, 0.75);
        }
        .week-nav button {
          background: #334155;
        }
        .week-nav button:hover {
          background: #475569;
        }
        .week-nav button:disabled {
          background: #1e293b;
        }
        .week-nav {
          background: rgba(15, 23, 42, 0.92);
          box-shadow: 0 18px 32px rgba(2, 6, 23, 0.65);
        }
        .cell {
          background: rgba(15, 23, 42, 0.95);
          border-color: rgba(148, 163, 184, 0.25);
          box-shadow: 0 1px 2px rgba(2, 6, 23, 0.6);
        }
        .cell.placeholder,
        .cell.past-day {
          background: rgba(30, 41, 59, 0.55);
          border-color: rgba(71, 85, 105, 0.6);
          box-shadow: none;
          color: rgba(203, 213, 225, 0.82);
        }
        .cell.placeholder .day-name,
        .cell.past-day .day-name {
          color: rgba(148, 163, 184, 0.75);
        }
        .segment {
          box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.35);
        }
        .segment:last-child {
          border-left: 1px solid rgba(71, 85, 105, 0.7);
        }
        .segment-label {
          color: rgba(226, 232, 240, 0.78);
        }
        .segment-available {
          background: rgba(34, 197, 94, 0.22);
          border-color: rgba(34, 197, 94, 0.45);
          color: #bbf7d0;
        }
        .segment-empty {
          background: rgba(30, 41, 59, 0.6);
          border-color: rgba(71, 85, 105, 0.7);
          color: rgba(226, 232, 240, 0.75);
        }
        .cell.placeholder .segment,
        .cell.past-day .segment {
          background: rgba(30, 41, 59, 0.42);
          border-color: rgba(71, 85, 105, 0.65);
          color: rgba(203, 213, 225, 0.72);
        }
        .cell.placeholder .segment-count,
        .cell.past-day .segment-count {
          color: inherit;
        }
        .mobile-segment-headers span {
          color: rgba(226, 232, 240, 0.74);
        }
        .segment-wrap::before {
          background: rgba(71, 85, 105, 0.65);
        }
        .segment-tooltip {
          background: rgba(15, 23, 42, 0.95);
          border-color: rgba(148, 163, 184, 0.22);
          box-shadow: 0 20px 45px rgba(2, 6, 23, 0.55);
          color: rgba(226, 232, 240, 0.85);
        }
        .segment-tooltip--above::before {
          border-right-color: rgba(148, 163, 184, 0.22);
          border-bottom-color: rgba(148, 163, 184, 0.22);
        }
        .segment-tooltip--below::before {
          border-left-color: rgba(148, 163, 184, 0.22);
          border-top-color: rgba(148, 163, 184, 0.22);
        }
        .segment-tooltip-secondary {
          display: none;
        }
        .empty-indicator {
          color: rgba(148, 163, 184, 0.5);
        }
        .overflow-indicator {
          background: rgba(71, 85, 105, 0.95) !important;
        }
        .initials-circle {
          border-color: rgba(255, 255, 255, 0.25);
        }
      }

      @media (min-width: 769px) {
        .cell {
          aspect-ratio: 1 / 1;
        }
      }
    </style>
  </head>
  <body>
    <div class="account-indicator" id="account-indicator" style="display: none;">
      <span id="account-email"></span>
      <a href="/settings.html" class="settings-btn" aria-label="Account settings" title="Account settings">‚öôÔ∏è</a>
    </div>

    <main>
      <header>
        <h1>
          <span class="timezone-label">üåç <span id="timezone">Europe/London</span></span>
          <span id="last-updated-inline" class="last-updated-inline">Loading‚Ä¶</span>
        </h1>
        <span class="header-separator">‚Ä¢</span>
        <span id="last-updated" class="header-meta">
          <span id="last-updated-text">Loading‚Ä¶</span>
          <span class="mobile-caption">Housemates free</span>
        </span>
        <a href="https://house-availability.simonwisdom.workers.dev/auth/google/start"
           class="connect-btn"
           id="connect-button"
           style="display: none;">Connect Google Calendar</a>
      </header>

      <div class="week-nav">
        <button id="prev-week">‚Üê Prev</button>
        <div class="week-title" id="week-title">Week of Oct 3</div>
        <button id="next-week">Next ‚Üí</button>
      </div>
      <section id="heat-grid"></section>
      <section id="legend"></section>
      <footer id="mobile-footer" class="mobile-footer">
        <span id="last-updated-mobile">Loading‚Ä¶</span>
      </footer>
    </main>

    <!-- Connect overlay shown when no data -->
    <div id="connect-overlay" class="connect-overlay" style="display: none;">
      <h2>Welcome to House Availability</h2>
      <p>Connect your calendar to see when housemates are free for events.</p>

      <div id="provider-selection" class="provider-buttons">
        <a class="connect-btn"
           id="overlay-connect-google"
           href="https://house-availability.simonwisdom.workers.dev/auth/google/start">Connect Google Calendar</a>
        <a class="connect-btn outlook"
           id="overlay-connect-outlook"
           href="https://house-availability.simonwisdom.workers.dev/auth/outlook/start">Connect Outlook Calendar</a>
        <button class="connect-btn apple" id="overlay-connect-apple">Connect Apple Calendar</button>
      </div>

      <form id="caldav-form" class="caldav-form">
        <h3 style="margin-top: 0;">Apple Calendar Setup</h3>
        <p style="font-size: 0.9rem;">You'll need an app-specific password from your iCloud settings.</p>
        <a href="https://support.apple.com/en-us/102654" target="_blank" style="font-size: 0.85rem; color: #4285f4;">How to generate an app-specific password ‚Üí</a>

        <label style="margin-top: 1rem;">
          Your Name
          <input type="text" id="caldav-name" placeholder="John Doe" required />
        </label>

        <label>
          Apple ID Email
          <input type="email" id="caldav-email" placeholder="your.email@gmail.com or you@icloud.com" required />
          <div class="hint">Use whatever email address is your Apple ID</div>
        </label>

        <label>
          App-Specific Password
          <input type="password" id="caldav-password" placeholder="xxxx-xxxx-xxxx-xxxx" required />
          <div class="hint">Generate this from appleid.apple.com ‚Üí Sign-In & Security ‚Üí App-Specific Passwords</div>
        </label>

        <button type="submit" class="connect-btn apple">Connect Calendar</button>
        <a class="back-link" id="back-to-providers">‚Üê Back to provider selection</a>
      </form>
    </div>
    <script>
      const workerOrigin = (() => {
        const { protocol, hostname, port } = window.location;
        if (port === "8788") return `${protocol}//${hostname}:8787`;
        if (port === "64510" || hostname === "localhost") return `${protocol}//${hostname}:${port}`;
        return "https://house-availability.simonwisdom.workers.dev";
      })();

      const isLocalDevelopment = ["localhost", "127.0.0.1"].includes(window.location.hostname);

      function ensureSettingsVisibleForLocal() {
        if (!isLocalDevelopment) return;
        const indicator = document.getElementById('account-indicator');
        const accountEmailEl = document.getElementById('account-email');
        if (indicator && accountEmailEl && (indicator.style.display === 'none' || indicator.style.display === '')) {
          accountEmailEl.textContent = accountEmailEl.textContent || '‚úì Local testing';
          indicator.style.display = 'flex';
        }
      }

      const palette = [
        "#F1F5F9",
        "#DCFCE7",
        "#BBF7D0",
        "#86EFAC",
        "#4ADE80",
        "#22C55E",
        "#16A34A",
        "#15803D"
      ];
      const weekdayNames = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
      const segmentOrder = ["morning", "evening"];
      const segmentLabels = {
        morning: "AM",
        evening: "PM"
      };
      const segmentHeaderLabels = {
        morning: "AM (9-12)",
        evening: "PM (6-10)"
      };

      function formatAvailabilityDisplay(count, useEmoji = false) {
        const value = Number.isFinite(count) ? count : 0;
        if (useEmoji) {
          if (value <= 0) return "‚Äî";
          const icon = "üßë";
          if (value <= 3) return icon.repeat(value);
          return `${icon}√ó${value}`;
        }
        if (value <= 0) return "‚Äî";
        return value.toString();
      }

      function formatAvailabilityDescription(count) {
        const value = Number.isFinite(count) ? count : 0;
        if (value <= 0) return "No one free";
        if (value === 1) return "1 person free";
        return `${value} people free`;
      }

      function formatMobileDayLabel(dateStr, weekday) {
        const date = new Date(`${dateStr}T00:00:00Z`);
        const dayPart = date.toLocaleDateString(undefined, {
          month: "short",
          day: "numeric"
        });
        return `${weekday} ${dayPart}`;
      }

      const heatGrid = document.getElementById("heat-grid");
      const tzEl = document.getElementById("timezone");
      const lastUpdatedContainer = document.getElementById("last-updated");
      const lastUpdatedTextEl = document.getElementById("last-updated-text");
      const lastUpdatedInlineEl = document.getElementById("last-updated-inline");
      const mobileFooter = document.getElementById("mobile-footer");
      const lastUpdatedMobileEl = document.getElementById("last-updated-mobile");
      const legend = document.getElementById("legend");
      const connectButton = document.getElementById("connect-button");
      const overlayConnectGoogle = document.getElementById("overlay-connect-google");
      const overlayConnectApple = document.getElementById("overlay-connect-apple");
      const providerSelection = document.getElementById("provider-selection");
      const caldavForm = document.getElementById("caldav-form");
      const backToProviders = document.getElementById("back-to-providers");
      const prevWeekBtn = document.getElementById("prev-week");
      const nextWeekBtn = document.getElementById("next-week");
      const weekTitle = document.getElementById("week-title");

      let currentWeekIndex = 0;
      let totalWeeks = 0;
      let availabilityUsers = {};
      let activeSegmentTooltip = null;
      let activeSegmentTrigger = null;
      let segmentTooltipId = 0;
      const pointerCoarseMedia = window.matchMedia('(pointer: coarse)');

      function isCoarsePointer() {
        return pointerCoarseMedia.matches;
      }

      function closeSegmentTooltip() {
        if (activeSegmentTooltip) {
          if (activeSegmentTooltip.parentElement) {
            activeSegmentTooltip.parentElement.removeChild(activeSegmentTooltip);
          }
          activeSegmentTooltip = null;
        }
        if (activeSegmentTrigger) {
          activeSegmentTrigger.classList.remove('tooltip-open');
          activeSegmentTrigger.setAttribute('aria-expanded', 'false');
          activeSegmentTrigger.removeAttribute('aria-describedby');
          activeSegmentTrigger = null;
        }
      }

      function getUserIdentity(userId) {
        const entry = availabilityUsers?.[userId];
        const email = entry?.email || '';
        const displayName = entry?.displayName?.trim() || '';
        const primary = displayName || email || userId;
        const displayLabel = primary.split(' ')[0];
        return { primary, displayLabel };
      }

      function getUserInitials(userId) {
        const entry = availabilityUsers?.[userId];
        const displayName = entry?.displayName?.trim() || '';
        const email = entry?.email || '';

        if (displayName) {
          // Extract first letter of first name and last name
          const parts = displayName.split(/\s+/);
          if (parts.length >= 2) {
            return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
          }
          // Single name: use first 2 letters
          return displayName.substring(0, 2).toUpperCase();
        }

        // Fallback to email prefix
        if (email) {
          const prefix = email.split('@')[0];
          return prefix.substring(0, 2).toUpperCase();
        }

        // Last resort: use userId
        return userId.substring(0, 2).toUpperCase();
      }

      function getUserColor(userId) {
        // Generate consistent color from userId hash
        const colorPalette = [
          '#4B89D9', '#22c55e', '#f59e0b', '#ec4899', '#8b5cf6',
          '#06b6d4', '#ef4444', '#10b981', '#f97316', '#a855f7',
          '#14b8a6', '#6366f1', '#84cc16', '#f43f5e', '#0ea5e9'
        ];

        // Simple hash function
        let hash = 0;
        for (let i = 0; i < userId.length; i++) {
          hash = ((hash << 5) - hash) + userId.charCodeAt(i);
          hash = hash & hash; // Convert to 32-bit integer
        }

        const index = Math.abs(hash) % colorPalette.length;
        return colorPalette[index];
      }

      function positionSegmentTooltip(triggerEl, tooltip) {
        if (!(triggerEl instanceof HTMLElement) || !(tooltip instanceof HTMLElement)) return;

        const triggerRect = triggerEl.getBoundingClientRect();
        const viewportPadding = 12;
        const viewportHeight = window.innerHeight;
        const offset = 8; // Gap between trigger and tooltip

        // Initially position below to measure
        tooltip.classList.remove('segment-tooltip--above');
        tooltip.classList.add('segment-tooltip--below');

        // Position at trigger location
        tooltip.style.left = `${triggerRect.left + triggerRect.width / 2}px`;
        tooltip.style.transform = 'translateX(-50%)';
        tooltip.style.top = `${triggerRect.bottom + offset}px`;

        requestAnimationFrame(() => {
          if (tooltip !== activeSegmentTooltip) return;
          if (!tooltip.isConnected) return;

          const tooltipRect = tooltip.getBoundingClientRect();
          const spaceBelow = viewportHeight - triggerRect.bottom;
          const tooltipHeight = tooltipRect.height;

          // Check if tooltip extends beyond viewport or if there's not enough space below
          if (tooltipRect.bottom > viewportHeight - viewportPadding || spaceBelow < tooltipHeight + offset + 20) {
            tooltip.classList.remove('segment-tooltip--below');
            tooltip.classList.add('segment-tooltip--above');
            tooltip.style.top = `${triggerRect.top - tooltipHeight - offset}px`;
          }
        });
      }

      function showSegmentTooltip(triggerEl) {
        if (!(triggerEl instanceof HTMLElement)) return;

        if (activeSegmentTrigger === triggerEl) {
          if (isCoarsePointer()) {
            closeSegmentTooltip();
          }
          return;
        }

        closeSegmentTooltip();

        const dateIso = triggerEl.dataset.date || '';
        const segmentKey = triggerEl.dataset.segmentKey || '';
        const userIds = (triggerEl.dataset.userIds || '').split(',').filter(Boolean);
        const isPlaceholder = triggerEl.dataset.placeholder === 'true';
        const tooltip = document.createElement('div');
        tooltip.className = 'segment-tooltip segment-tooltip--below';
        tooltip.setAttribute('role', 'tooltip');
        const tooltipId = `segment-tooltip-${++segmentTooltipId}`;
        tooltip.id = tooltipId;

        const body = document.createElement('div');
        body.className = 'segment-tooltip-body';

        if (userIds.length === 0) {
          body.textContent = isPlaceholder
            ? 'No availability yet.'
            : 'No one free.';
        } else {
          const list = document.createElement('ul');
          list.className = 'segment-tooltip-list';

          userIds
            .map((id) => ({ id, ...getUserIdentity(id) }))
            .sort((a, b) => a.primary.localeCompare(b.primary))
            .forEach((entry) => {
              const item = document.createElement('li');

              const primary = document.createElement('span');
              primary.className = 'segment-tooltip-primary';
              primary.textContent = entry.displayLabel;

              item.appendChild(primary);

              list.appendChild(item);
            });

          body.appendChild(list);
        }

        tooltip.append(body);
        tooltip.addEventListener('click', (event) => event.stopPropagation());

        document.body.appendChild(tooltip);
        triggerEl.classList.add('tooltip-open');
        triggerEl.setAttribute('aria-expanded', 'true');
        triggerEl.setAttribute('aria-describedby', tooltipId);

        activeSegmentTooltip = tooltip;
        activeSegmentTrigger = triggerEl;

        positionSegmentTooltip(triggerEl, tooltip);
      }

      function handleSegmentClick(event) {
        event.stopPropagation();
        if (!isCoarsePointer()) {
          return;
        }
        const target = event.currentTarget;
        if (target instanceof HTMLElement) {
          showSegmentTooltip(target);
        }
      }

      function handleSegmentMouseEnter(event) {
        if (isCoarsePointer()) return;
        const target = event.currentTarget;
        if (target instanceof HTMLElement) {
          showSegmentTooltip(target);
        }
      }

      function handleSegmentMouseLeave(event) {
        if (isCoarsePointer()) return;
        const target = event.currentTarget;
        if (target === activeSegmentTrigger) {
          closeSegmentTooltip();
        }
      }

      function handleSegmentFocus(event) {
        const target = event.currentTarget;
        if (target instanceof HTMLElement) {
          showSegmentTooltip(target);
        }
      }

      function handleSegmentBlur(event) {
        const target = event.currentTarget;
        if (target === activeSegmentTrigger) {
          closeSegmentTooltip();
        }
      }

      function handleSegmentKeydown(event) {
        if (event.key === 'Enter' || event.key === ' ') {
          event.preventDefault();
          const target = event.currentTarget;
          if (target instanceof HTMLElement) {
            showSegmentTooltip(target);
          }
        }
      }

      document.addEventListener('click', () => {
        if (!activeSegmentTooltip) return;
        closeSegmentTooltip();
      });

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          closeSegmentTooltip();
        }
      });

      if (typeof pointerCoarseMedia.addEventListener === 'function') {
        pointerCoarseMedia.addEventListener('change', closeSegmentTooltip);
      } else if (typeof pointerCoarseMedia.addListener === 'function') {
        pointerCoarseMedia.addListener(closeSegmentTooltip);
      }

      window.addEventListener('resize', closeSegmentTooltip);
      window.addEventListener('scroll', closeSegmentTooltip, { passive: true });

      if (connectButton) {
        connectButton.href = `${workerOrigin}/auth/google/start`;
      }
      if (overlayConnectGoogle) {
        overlayConnectGoogle.href = `${workerOrigin}/auth/google/start`;
      }

      // Handle Apple Calendar button click
      if (overlayConnectApple) {
        overlayConnectApple.addEventListener("click", () => {
          providerSelection.style.display = "none";
          caldavForm.classList.add("active");
        });
      }

      // Handle back to provider selection
      if (backToProviders) {
        backToProviders.addEventListener("click", (e) => {
          e.preventDefault();
          caldavForm.classList.remove("active");
          providerSelection.style.display = "flex";
        });
      }

      // Handle CalDAV form submission
      if (caldavForm) {
        caldavForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const displayName = document.getElementById("caldav-name").value.trim();
          const email = document.getElementById("caldav-email").value.trim();
          const password = document.getElementById("caldav-password").value.trim();

          try {
            const response = await fetch(`${workerOrigin}/auth/caldav/setup`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              credentials: "include",
              body: JSON.stringify({ displayName, email, password })
            });

            const result = await response.json();
            if (result.ok && result.redirectUrl) {
              window.location.href = result.redirectUrl;
            } else {
              alert(`Setup failed: ${result.error || "Unknown error"}`);
            }
          } catch (error) {
            console.error("CalDAV setup error:", error);
            alert("Failed to connect. Please check your credentials and try again.");
          }
        });
      }

      function setLastUpdatedDisplay(text) {
        const content = text || 'Loading‚Ä¶';
        if (lastUpdatedTextEl) {
          lastUpdatedTextEl.textContent = content;
        }
        if (lastUpdatedInlineEl) {
          lastUpdatedInlineEl.textContent = content;
        }
        if (lastUpdatedMobileEl) {
          lastUpdatedMobileEl.textContent = content;
        }
      }

      function formatDate(dateStr) {
        const date = new Date(`${dateStr}T00:00:00Z`);
        return date.toLocaleDateString(undefined, {
          month: "short",
          day: "numeric"
        });
      }

      function formatWeekLabel(dateStr) {
        const date = new Date(`${dateStr}T00:00:00Z`);
        return date.toLocaleDateString(undefined, {
          month: "short",
          day: "numeric"
        });
      }

      function offsetIsoDate(baseIso, offsetDays) {
        const date = new Date(`${baseIso}T00:00:00Z`);
        date.setUTCDate(date.getUTCDate() + offsetDays);
        return date.toISOString().split('T')[0];
      }

      function formatRelative(datetime, timezone) {
        if (!datetime) return "Not synced";
        const date = new Date(datetime);
        const formatted = new Intl.DateTimeFormat(undefined, {
          dateStyle: "medium",
          timeStyle: "short",
          timeZone: timezone
        }).format(date);
        return `Updated ${formatted}`;
      }

      function getTodayIso(timezone) {
        return new Intl.DateTimeFormat("en-CA", { timeZone: timezone }).format(new Date());
      }

      function buildWeeks(days) {
        const weeks = [];
        let currentWeek = new Array(7).fill(null);

        days.forEach((day) => {
          const dateObj = new Date(`${day.date}T00:00:00Z`);
          const weekday = (dateObj.getUTCDay() + 6) % 7; // Monday-first

          if (currentWeek[weekday]) {
            weeks.push(currentWeek);
            currentWeek = new Array(7).fill(null);
          }

          currentWeek[weekday] = day;

          if (weekday === 6) {
            weeks.push(currentWeek);
            currentWeek = new Array(7).fill(null);
          }
        });

        if (currentWeek.some(Boolean)) {
          weeks.push(currentWeek);
        }

        return weeks;
      }

      function buildLegend(maxCount, scaleMax) {
        legend.innerHTML = "";
        const frag = document.createDocumentFragment();
        const capped = scaleMax || 0;

        for (let i = 0; i <= capped; i += 1) {
          const colorIdx = capped === 0 ? 0 : Math.round((i / capped) * (palette.length - 1));
          const span = document.createElement("span");
          span.className = "legend-item";
          span.innerHTML = `<span class="swatch" style="background:${palette[colorIdx]}"></span>${i} free`;
          frag.appendChild(span);
        }

        legend.appendChild(frag);
      }

      function updateWeekNavigation() {
        if (prevWeekBtn && nextWeekBtn) {
          prevWeekBtn.disabled = currentWeekIndex === 0;
          nextWeekBtn.disabled = currentWeekIndex >= totalWeeks - 1;
        }

        // Update visible week on mobile
        const allElements = document.querySelectorAll('.week-row');
        allElements.forEach((el) => {
          const weekIdx = parseInt(el.dataset.weekIndex);
          if (weekIdx === currentWeekIndex) {
            el.classList.add('active');
          } else {
            el.classList.remove('active');
          }
        });
      }

      function renderHeatMap(data) {
        const timezone = data.timezone || "Europe/London";
        if (tzEl) tzEl.textContent = timezone;
        setLastUpdatedDisplay(formatRelative(data.lastUpdatedIso, timezone));
        closeSegmentTooltip();

        // Calculate unique contributing users
        const uniqueUsers = new Set();
        data.days.forEach(day => {
          if (day.freeUserIds && Array.isArray(day.freeUserIds)) {
            day.freeUserIds.forEach(userId => uniqueUsers.add(userId));
          }
        });
        const userCount = uniqueUsers.size;

        // Update account indicator with user count
        const accountEmailEl = document.getElementById('account-email');
        const userEmail = localStorage.getItem('user_email');
        if (accountEmailEl && userEmail && userCount > 0) {
          accountEmailEl.textContent = `‚úì ${userEmail} (${userCount} user${userCount !== 1 ? 's' : ''})`;
        }

        const weeks = buildWeeks(data.days);
        totalWeeks = weeks.length;

        // Find the week containing today
        const todayIso = getTodayIso(timezone);
        currentWeekIndex = weeks.findIndex(week =>
          week.some(day => day && day.date === todayIso)
        );
        if (currentWeekIndex === -1) currentWeekIndex = 0;

        const currentWeekDays = weeks[currentWeekIndex] || [];
        const todayWeekIndex = currentWeekDays.findIndex(day => day && day.date === todayIso);

        const maxSegment = data.days.reduce((acc, day) => {
          const segments = day.segments || {};
          let localMax = acc;
          segmentOrder.forEach((key) => {
            const value = segments[key]?.freeCount ?? 0;
            if (value > localMax) localMax = value;
          });
          return localMax;
        }, 0);
        const segmentScaleMax = Math.max(maxSegment, palette.length - 1);

        heatGrid.innerHTML = "";
        const frag = document.createDocumentFragment();

        const mobileLayout = window.matchMedia("(max-width: 768px)").matches;

        const headerRow = document.createElement("div");
        headerRow.className = "weekday-row";

        const spacer = document.createElement("div");
        spacer.className = "week-label heading";
        headerRow.appendChild(spacer);

        weekdayNames.forEach((name) => {
          const head = document.createElement("div");
          head.className = "weekday heading";
          head.textContent = name;
          headerRow.appendChild(head);
        });

        frag.appendChild(headerRow);

        weeks.forEach((week, weekIdx) => {
          const firstDay = week.find(Boolean);

          const group = document.createElement("div");
          group.className = "week-group week-row";
          group.dataset.weekIndex = weekIdx;

          const label = document.createElement("div");
          label.className = "week-label";
          label.textContent = firstDay ? `Week of ${formatWeekLabel(firstDay.date)}` : "";
          group.appendChild(label);

          if (mobileLayout) {
            const headersRow = document.createElement("div");
            headersRow.className = "mobile-segment-headers";
            const headerParts = ["<span>Day</span>"];
            segmentOrder.forEach((segmentKey) => {
              headerParts.push(`<span>${segmentHeaderLabels[segmentKey]}</span>`);
            });
            headersRow.innerHTML = headerParts.join("");
            group.appendChild(headersRow);
          }

          const daysWrap = document.createElement("div");
          daysWrap.className = "week-days";
          group.appendChild(daysWrap);

          week.forEach((originalDay, idx) => {
            const cell = document.createElement("div");
            cell.className = "cell";
            cell.dataset.weekIndex = weekIdx;

            let dayData = originalDay;
            let isPlaceholder = false;

            if (!dayData) {
              if (
                weekIdx === currentWeekIndex &&
                todayWeekIndex !== -1 &&
                idx < todayWeekIndex
              ) {
                const placeholderIso = offsetIsoDate(todayIso, idx - todayWeekIndex);
                dayData = {
                  date: placeholderIso,
                  freeCount: 0,
                  segments: {},
                  placeholder: true
                };
                isPlaceholder = true;
              } else {
                cell.classList.add("empty");
                daysWrap.appendChild(cell);
                return;
              }
            }

            cell.dataset.date = dayData.date;

            const isPastDay = weekIdx === currentWeekIndex && dayData.date < todayIso;

            if (idx >= 5) cell.classList.add("weekend");
            if (isPlaceholder) cell.classList.add("placeholder");
            if (isPastDay) cell.classList.add("past-day");

            const dayName = document.createElement("div");
            dayName.className = "day-name";
            dayName.textContent = mobileLayout
              ? formatMobileDayLabel(dayData.date, weekdayNames[idx])
              : weekdayNames[idx];

            const segmentWrap = document.createElement("div");
            segmentWrap.className = "segment-wrap";

            segmentOrder.forEach((segmentKey) => {
              const segmentData = (dayData.segments && dayData.segments[segmentKey]) || { freeCount: 0 };
              const segmentEl = document.createElement("div");
              segmentEl.className = `segment segment-${segmentKey}`;

              const segmentLabel = document.createElement("div");
              segmentLabel.className = "segment-label";
              segmentLabel.textContent = segmentLabels[segmentKey];

              const freeUserIds = Array.isArray(segmentData.freeUserIds) ? segmentData.freeUserIds : [];
              const rawSegmentCount = segmentData.freeCount ?? 0;

              // Create content container - either initials (mobile) or count (desktop)
              let contentEl;

              if (mobileLayout) {
                // Mobile: show initials circles
                const initialsContainer = document.createElement("div");
                initialsContainer.className = "initials-container";

                if (rawSegmentCount > 0 && !isPlaceholder && !isPastDay) {
                  const maxVisible = 7;
                  const visibleUsers = freeUserIds.slice(0, maxVisible);
                  const overflowCount = Math.max(0, freeUserIds.length - maxVisible);

                  // Create circles for visible users
                  visibleUsers.forEach(userId => {
                    const circle = document.createElement("div");
                    circle.className = "initials-circle";
                    circle.textContent = getUserInitials(userId);
                    circle.style.backgroundColor = getUserColor(userId);
                    circle.title = getUserIdentity(userId).primary;
                    initialsContainer.appendChild(circle);
                  });

                  // Add overflow indicator if needed
                  if (overflowCount > 0) {
                    const overflow = document.createElement("div");
                    overflow.className = "initials-circle overflow-indicator";
                    overflow.textContent = `+${overflowCount}`;
                    overflow.title = `${overflowCount} more`;
                    initialsContainer.appendChild(overflow);
                  }
                } else {
                  // Empty state: show dash
                  const emptyIndicator = document.createElement("div");
                  emptyIndicator.className = "empty-indicator";
                  emptyIndicator.textContent = "‚Äî";
                  initialsContainer.appendChild(emptyIndicator);
                }
                contentEl = initialsContainer;
              } else {
                // Desktop: show count number
                const segmentCount = document.createElement("div");
                segmentCount.className = "segment-count";
                segmentCount.textContent = formatAvailabilityDisplay(rawSegmentCount, false);
                contentEl = segmentCount;
              }

              segmentEl.dataset.userIds = freeUserIds.join(',');
              segmentEl.dataset.date = dayData.date;
              segmentEl.dataset.segmentKey = segmentKey;
              segmentEl.dataset.placeholder = isPlaceholder ? 'true' : 'false';
              segmentEl.dataset.past = isPastDay ? 'true' : 'false';
              segmentEl.setAttribute('role', 'button');
              segmentEl.setAttribute('aria-haspopup', 'true');
              segmentEl.setAttribute('aria-expanded', 'false');
              segmentEl.tabIndex = 0;
              segmentEl.addEventListener('click', handleSegmentClick);
              segmentEl.addEventListener('keydown', handleSegmentKeydown);
              segmentEl.addEventListener('mouseenter', handleSegmentMouseEnter);
              segmentEl.addEventListener('mouseleave', handleSegmentMouseLeave);
              segmentEl.addEventListener('focus', handleSegmentFocus);
              segmentEl.addEventListener('blur', handleSegmentBlur);

              const treatAsAvailable = rawSegmentCount > 0 && !isPastDay && !isPlaceholder;
              if (treatAsAvailable) {
                segmentEl.classList.add("segment-available");

                // Apply color gradient on all views
                if (segmentScaleMax > 0) {
                  const colorIndex = Math.round((rawSegmentCount / segmentScaleMax) * (palette.length - 1));
                  const bgColor = palette[Math.min(colorIndex, palette.length - 1)];
                  segmentEl.style.backgroundColor = bgColor;

                  // Adjust text color based on background brightness
                  const isDark = colorIndex >= 5; // Green palette gets darker after index 5
                  if (isDark) {
                    segmentEl.style.color = '#ffffff';
                  }
                }
              } else {
                segmentEl.classList.add("segment-empty");
              }

              const tooltipText = `${segmentHeaderLabels[segmentKey]}: ${formatAvailabilityDescription(rawSegmentCount)}`;
              segmentEl.title = tooltipText;
              segmentEl.setAttribute("aria-label", tooltipText);

              segmentEl.append(segmentLabel, contentEl);
              segmentWrap.appendChild(segmentEl);
            });

            if (mobileLayout) {
              cell.append(dayName, segmentWrap);
            } else {
              const count = document.createElement("div");
              count.className = "count";
              count.textContent = formatAvailabilityDisplay(dayData.freeCount ?? 0);

              const dateLabel = document.createElement("div");
              dateLabel.className = "date";
              dateLabel.textContent = formatDate(dayData.date);

              cell.append(dayName, count, segmentWrap, dateLabel);
            }
            daysWrap.appendChild(cell);
          });

          frag.appendChild(group);
        });

        heatGrid.appendChild(frag);
        buildLegend(maxSegment, segmentScaleMax);

        // Update week title
        const currentWeekForTitle = weeks[currentWeekIndex];
        const firstDay = currentWeekForTitle ? currentWeekForTitle.find(Boolean) : null;
        if (weekTitle && firstDay) {
          weekTitle.textContent = `Week of ${formatWeekLabel(firstDay.date)}`;
        }

        updateWeekNavigation();
      }

      async function loadAvailability() {
        try {
          const response = await fetch(`${workerOrigin}/api/availability`, {
            credentials: "include"
          });

          if (!response.ok) {
            showConnectState();
            return;
          }

          const data = await response.json();
          availabilityUsers = data.users || {};

          // Check if we have any data
          if (!data.days || data.days.length === 0) {
            showConnectState();
            return;
          }

          // Check if all days have 0 free count (no users connected)
          const hasAnyData = data.days.some(day => day.freeCount > 0);
          if (!hasAnyData) {
            showConnectState();
            return;
          }

          // We have real data, show it
          hideConnectState();
          renderHeatMap(data);

          // Load user info to populate localStorage and show settings button
          await loadUserInfo();
          loadUserCalendars();
        } catch (error) {
          setLastUpdatedDisplay("Unable to load availability.");
          console.error(error);
          showConnectState();
        }
      }

      async function loadUserInfo() {
        try {
          const response = await fetch(`${workerOrigin}/api/user/info`, {
            credentials: "include"
          });

          if (!response.ok) return;

          const data = await response.json();
          if (data.ok && data.email) {
            localStorage.setItem('user_email', data.email);
          }
        } catch (error) {
          console.error('Failed to load user info:', error);
        }
      }

      async function loadUserCalendars() {
        const userEmail = localStorage.getItem('user_email');
        if (!userEmail) return;

        // Show account indicator
        const accountIndicator = document.getElementById('account-indicator');
        const accountEmailEl = document.getElementById('account-email');
        if (accountIndicator && accountEmailEl) {
          accountEmailEl.textContent = `‚úì ${userEmail}`;
          accountIndicator.style.display = 'flex';
        }
      }

      function showConnectState() {
        // Show connect button in header
        if (connectButton) {
          connectButton.style.display = 'inline-block';
        }
        if (lastUpdatedContainer) {
          lastUpdatedContainer.style.display = 'none';
        }
        if (mobileFooter) {
          mobileFooter.style.display = 'none';
        }

        // Show overlay
        document.getElementById('connect-overlay').style.display = 'block';

        // Blur the grid
        if (heatGrid) {
          heatGrid.classList.add('blur-mode');
        }
        if (legend) {
          legend.classList.add('blur-mode');
        }

        ensureSettingsVisibleForLocal();

        // Add some placeholder data for visual effect
        renderPlaceholderGrid();
      }

      function hideConnectState() {
        if (connectButton) {
          connectButton.style.display = 'none';
        }
        if (lastUpdatedContainer) {
          lastUpdatedContainer.style.display = '';
        }
        if (mobileFooter) {
          mobileFooter.style.display = '';
        }
        document.getElementById('connect-overlay').style.display = 'none';
        if (heatGrid) {
          heatGrid.classList.remove('blur-mode');
        }
        if (legend) {
          legend.classList.remove('blur-mode');
        }

        ensureSettingsVisibleForLocal();
      }

      function renderPlaceholderGrid() {
        // Generate fake data for visual appeal
        const fakeDays = [];
        const today = new Date();
        availabilityUsers = {};
        closeSegmentTooltip();
        for (let i = 0; i < 28; i++) {
          const date = new Date(today);
          date.setDate(date.getDate() + i);
          const morning = Math.floor(Math.random() * 5);
          const evening = Math.floor(Math.random() * 5);
          fakeDays.push({
            date: date.toISOString().split('T')[0],
            freeCount: Math.max(morning, evening),
            segments: {
              morning: { freeCount: morning },
              evening: { freeCount: evening }
            }
          });
        }

        renderHeatMap({
          timezone: 'Europe/London',
          days: fakeDays,
          lastUpdatedIso: null
        });
      }

      // Week navigation handlers
      if (prevWeekBtn) {
        prevWeekBtn.addEventListener('click', () => {
          if (currentWeekIndex > 0) {
            currentWeekIndex--;
            const firstCell = document.querySelector(`[data-week-index="${currentWeekIndex}"].cell:not(.empty)`);
            const dateIso = firstCell?.dataset.date;
            if (weekTitle && dateIso) {
              weekTitle.textContent = `Week of ${formatWeekLabel(dateIso)}`;
            }
            closeSegmentTooltip();
            updateWeekNavigation();
          }
        });
      }

      if (nextWeekBtn) {
        nextWeekBtn.addEventListener('click', () => {
          if (currentWeekIndex < totalWeeks - 1) {
            currentWeekIndex++;
            const firstCell = document.querySelector(`[data-week-index="${currentWeekIndex}"].cell:not(.empty)`);
            const dateIso = firstCell?.dataset.date;
            if (weekTitle && dateIso) {
              weekTitle.textContent = `Week of ${formatWeekLabel(dateIso)}`;
            }
            closeSegmentTooltip();
            updateWeekNavigation();
          }
        });
      }

      loadAvailability();
      ensureSettingsVisibleForLocal();
    </script>
  </body>
</html>
